Include("\\script\\activitysys\\config\\38\\head.lua")
Include("\\script\\activitysys\\config\\38\\variables.lua")
Include("\\script\\activitysys\\config\\38\\gift_pos.lua")
Include("\\script\\global\\autoexec_head.lua")
Include("\\script\\activitysys\\npcfunlib.lua")
Include("\\script\\activitysys\\playerfunlib.lua")
Include("\\script\\activitysys\\config\\38\\award.lua")
Include("\\script\\lib\\awardtemplet.lua")

pActivity.nPak = curpack()

EVENT_LOG_TITLE = "SPRING FESTIVIAL"
function pActivity:InitAddNpc()
	self:AddPlutus()
	self:AddGiftNpc()
	self:AddAmbienceNpc()
end

function pActivity:PlayerOnLogin()

	if GetTask(3907) ~= 5 then
		SetTask(3907,5)--task kiem tra event dot truoc moi dot event tang len 1
		--SetTask(3908,0)--task nhan moc 1000
		--SetTask(3909,0)--task event loai 3
		--SetTask(3910,0) --ev kvan
		--SetTask(3911,0) --ev xu
		--SetTask(3912,0) --thuong free event
		self:SetTask(TSK_SUDUNG_BANHCHUNG,0)
		self:SetTask(TSK_SUDUNG_MAMNGUQUA,0)
		self:SetTask(TSK_BAOLIXISD,0)
		self:SetTask(TSK_BAOLIXI,0)
	end
end

function pActivity:UseNewYearGift()
	local AWARD_TABLE = tbAwardList["Gift_Item"]
	tbAwardTemplet:Give(AWARD_TABLE, 1, {EVENT_LOG_TITLE, "get gift award by item"})
	--mini game - Modified By DinhHQ - 20120103
	local nStartTime = 20170127
	local nEndTime = 20180305
	local nCurrTime = tonumber(GetLocalDate("%Y%m%d"))
	if nCurrTime >= nStartTime and nCurrTime < nEndTime then
		local tbMiniGameAward = 
		{
			{szName="M∆t nπ - Long Ch©u",tbProp={0,11,75,1,0,0},nCount=1,nRate=10,nExpiredTime=10080},
			{szName="M∆t nπ - ß«u RÂng",tbProp={0,11,76,1,0,0},nCount=1,nRate=10,nExpiredTime=10080},
			{szName="M∆t nπ - Th©n RÂng",tbProp={0,11,77,1,0,0},nCount=1,nRate=10,nExpiredTime=10080},
			{szName="M∆t nπ - ßu´i RÂng",tbProp={0,11,78,1,0,0},nCount=1,nRate=10,nExpiredTime=10080},
			{szName="M∆t nπ - ß«u ´ng Æﬁa",tbProp={0,11,72,1,0,0},nCount=1,nRate=10,nExpiredTime=10080},
			{szName="M∆t nπ - Nam S≠ ",tbProp={0,11,73,1,0,0},nCount=1,nRate=10,nExpiredTime=10080},
			{szName="M∆t nπ - Bæc S≠ ",tbProp={0,11,74,1,0,0},nCount=1,nRate=10,nExpiredTime=10080},
			{szName="M∆t nπ - Bæc S≠ ",tbProp={0,11,74,1,0,0},nCount=1,nRate=10,nExpiredTime=10080},
			{szName="Ph∏o hoa mıng xu©n",tbProp={6, 1, 3087, 1,0,0},nCount=1,nRate=20,nExpiredTime=20180305,},
		}
		tbAwardTemplet:Give(tbMiniGameAward, 1, {EVENT_LOG_TITLE, "SuDungLeVatNamMoiNhanMatNa"})
	end
	
	--local solansudung = self:GetTask(%TSK_GET_NEWYEAR_GIFT_DAILY)
	--Msg2Player("H´m nay Æ∑ sˆ dÙng: " .. solansudung .. " l«n")

end

function pActivity:UseNewYearFireworks()
	local AWARD_TABLE = tbAwardList["Fireworks"]
	tbAwardTemplet:Give(AWARD_TABLE, 1, {EVENT_LOG_TITLE, "get gift award by item"})
	tbVngTransLog:Write("201201_event_tet/", 22, "SuDungPhaoHoaNamMoi", "N/A", 1)
	local nSkillId = 1175
	local _,nX32,nY32 = GetWorldPos()
	CastSkill(nSkillId, 1, nX32*32, nY32*32) -- –¬ƒÍøÏ¿÷—Ãª®ººƒ‹

	--local solansudung = self:GetTask(%TSK_USED_NEWYEAR_FIREWORKS)
	--Msg2Player("H´m nay Æ∑ sˆ dÙng: " .. solansudung .. " l«n")
end

function pActivity:CheckFireworksUseTime()
	local nStartTime = 20180127
	local nEndTime = 20180305
	local nCurrTime = tonumber(GetLocalDate("%Y%m%d"))
	
	if nCurrTime >= nStartTime and nCurrTime < nEndTime then
		return 1
	else
		Msg2Player(format("ThÍi gian hi÷n tπi kh´ng ÆÛng, xin h∑y ÆÓi Æ’n %3$d-%2$d-%1$d Æ’n %5$d-%4$d-%1$d h∑y sˆ dÙng nh–!",2017,1,27,2,27))
	end
end

local tbPool = 
{
	[2] = {{nX = 2571, nY = 3509, nR = 100}},
}

function InMap(nMapId)
	local nFlag = 0
	for nTmpMapId, _ in %tbPool do
		if nTmpMapId == nMapId then
			nFlag = 1
			break
		end
	end
	return nFlag
end

function IsInDistance(nX, nY, tbPosList)
	for _, tbPos in tbPosList do
		local nDis = (nX - tbPos.nX)^2 + (nY - tbPos.nY)^2
--		print("nX, nY, nR,nDis", tbPos.nX, tbPos.nY, tbPos.nR, nDis)
		if tbPos.nR > nDis then
			return 1
		end
	end
	return
end

function pActivity:CheckFireworksUseTime()
	local nStartTime = 20180216
	local nEndTime = 20180220
	local nCurrTime = tonumber(GetLocalDate("%Y%m%d"))
	local nStartHour = 1900
	local nEndHour = 1916
	local nCurHour = tonumber(date("%H%M"))
	local nMapId, nX, nY = GetWorldPos()
	
	if not (nCurrTime >= nStartTime and nCurrTime < nEndTime) then
		Say("Tı ngµy 16/02 Æ’n ngµy 19/02 mÌi c„ th” sˆ dÙng")
	elseif not (nCurHour >= nStartHour and nCurHour < nEndHour) then
		Say("Vµo lÛc 19h00 Æ’n 19h15 mang ph∏o hoa nµy Æ’n Æÿnh Hoa S¨n t‰a ÆÈ 321/219 Æ” chung vui cÔng bπn h˜u")
	elseif InMap(nMapId) ~= 1 then
		Say("Mang ph∏o hoa nµy Æ’n Æÿnh Hoa S¨n Æ” chung vui cÔng bπn h˜u")
	elseif IsInDistance(nX, nY, %tbPool[nMapId]) ~= 1 then
		Say("Mang ph∏o hoa nµy Æ’n Æÿnh Hoa S¨n t‰a ÆÈ 321/219 Æ” chung vui cÔng bπn h˜u")
	else
		return 1
	end

end

function pActivity:AddPlutus()
	local szNpcName = "ßπi Th«n Tµi"
	local nNpcId = 1528
	local tbNpcPos = {
		{176,1585,2953},
		{1,1584,3192},
		{37,1709,3118},
		{162,1621,3183},
		{78,1586,3223},
		{11,3139,5063}}
			
	NpcFunLib:AddDialogNpc(szNpcName, nNpcId, tbNpcPos)
end

function pActivity:AddGiftNpc()
	local nMapIndex = SubWorldID2Idx(%GIFT_MAPID)
	if nMapIndex < 0 then
		return
	end
	local szNpcName = "L‘ VÀt N®m MÌi"
	local nNpcId = 1288
	for i=1, getn(%GIFT_POS) do
		local nX, nY = %GIFT_POS[i][1], %GIFT_POS[i][2]
		local nNpcIndex = AddNpc(nNpcId, 1, nMapIndex, nX*32, nY*32, 0, szNpcName);
		SetNpcScript(nNpcIndex, "\\script\\activitysys\\config\\38\\npc_gift.lua")
	end
end

function pActivity:AddAmbienceNpc()
	Include("\\script\\activitysys\\config\\38\\ambience_npc.lua")
	DynamicExecute("\\script\\activitysys\\ambience.lua", "tbAmbience:CreateNpc",tbAmbienceNpc)
end


function pActivity:ExpiredTime()
	return self:IsExpired() 
end

function pActivity:CheckGifeGetDaily()
	if self:CheckTaskDaily(%TSK_GET_NEWYEAR_GIFT_DAILY, %MAX_GET_NEWYEAR_GIFT_DAILY, "H´m nay ng≠¨i Æ∑ thu thÀp ÆÒ, ngµy mai h∑y quay lπi nh–!", "<") == 1 then
		return 1
	else
		return 0
	end
end

function pActivity:GetNewYearGift()
	self:AddTaskDaily(%TSK_GET_NEWYEAR_GIFT_DAILY, 1)
end

IncludeLib("RELAYLADDER");

function pActivity:XemTOP3Event()
	local sResult = ""
	for i = 1, 3 do
		local nten, ncap,nphai = Ladder_GetLadderInfo(10282, i)
		sResult = sResult.."\r\n TOP "..i.." - <"..nten.."> sË l«n: <"..ncap..">"
	end
	Say("Danh s∏ch b∂ng x’p hπng TOP 3 event k˙ nµy: \r\n" .. sResult)
end

function pActivity:TetND2016_MamNguQua()

	local nCurCount = self:GetTask(%TSK_SUDUNG_MAMNGUQUA)
	nCurCount = nCurCount + 1
	Msg2Player("ß∑ sˆ dÙng: " .. nCurCount .. " l«n")

	local tbExpAward = 
	{
		[1] = {szName = "ßi”m kinh nghi÷m", nExp = 1500000},
	}
	tbAwardTemplet:Give(tbExpAward, 1 , {EVENT_LOG_TITLE, "SuDungMamNguQuaMD"})
	--Phan thuong them
	local tbItemAward = 
	{
			{szName = "Kim t™",tbProp={4,979,1,1,0,0},nCount=1,nRate=0.1},
			{szName = "Th«n b› kho∏ng thπch", tbProp={6,1,398,1,0,0},nCount=1, nRate =0.1},

			{szName = "Huy“n tinh c p 1", tbProp={6,1,147,1,0,0},nCount=1, nRate =5},--25 cai
			{szName = "Huy“n tinh c p 2", tbProp={6,1,147,2,0,0},nCount=1, nRate =0.5},
			{szName = "Huy“n tinh c p 3", tbProp={6,1,147,3,0,0},nCount=1, nRate =0.3},
			{szName = "Huy“n tinh c p 4", tbProp={6,1,147,4,0,0},nCount=1, nRate =0.2},
			{szName = "Huy“n tinh c p 5", tbProp={6,1,147,5,0,0},nCount=1, nRate =0.1},

			{szName = "Ti™n th∂o lÈ ß∆c Bi÷t",tbProp={6,1,1181,1,0,0},nCount=1, nRate=0.2},--1 cai
			{szName = "Ti™n th∂o lÈ",tbProp={6,1,71,1,0,0},nCount=1, nRate=2},--10 cai
			{szName = "N’n B∏t tr©n phÛc nguy÷t", nRate = 0.2,   tbProp = {6, 1, 1817, 1, 0, 0}, nCount=1},	
			{szName = "Th≠ Æ∆c x∏ tri“u Æ◊nh", tbProp={6,1,1375,1,0,0},nCount=1, nRate =0.1},
			{szName = "Tˆ m…u l÷nh",tbProp={6,1,1427,1,0,0},nCount=1,nRate=0.1},
			{szName = "Tinh hÂng b∂o thπch",					tbProp={4,353,1,1,0,0},nCount=1,nRate=0.4},--2 vien
			{szName = "Tˆ thÒy tinh",								tbProp={4,239,1,1,0,0},nCount=1,nRate=0.1},
			{szName = "LÙc thÒy tinh",								tbProp={4,240,1,1,0,0},nCount=1,nRate=0.1},
			{szName = "Lam thÒy tinh",							tbProp={4,238,1,1,0,0},nCount=1,nRate=0.1},
			{szName = "Qu’ hoa tˆu",tbProp={6,1,125,1,0,0},nCount=1,nRate=0.4},--2 vien
			{szName = "V‚ l©m mÀt tﬁch",tbProp={6,1,26,1,0,0},nCount=1,nRate=0.1},
			{szName = "T»y tÒy kinh",tbProp={6,1,22,1,0,0},nCount=1,nRate=0.1},
			{szName= "TÛi danh v‰ng",tbProp={6,1,4338,1,0,0},nCount=1,nRate=2},--10 cai

			{szName="M∂nh Tµng B∂o ßÂ 1",tbProp={4,490,1,1,0,0},nCount=1,nRate=0.02},
			{szName="M∂nh Tµng B∂o ßÂ 2",tbProp={4,491,1,1,0,0},nCount=1,nRate=0.02},
			{szName="M∂nh Tµng B∂o ßÂ 3",tbProp={4,492,1,1,0,0},nCount=1,nRate=0.02},
			{szName="M∂nh Tµng B∂o ßÂ 4",tbProp={4,493,1,1,0,0},nCount=1,nRate=0.02},
			{szName="M∂nh Tµng B∂o ßÂ 5",tbProp={4,494,1,1,0,0},nCount=1,nRate=0.02},
			{szName="M∂nh Tµng B∂o ßÂ 6",tbProp={4,495,1,1,0,0},nCount=1,nRate=0.02},
			{szName="M∂nh Tµng B∂o ßÂ 7",tbProp={4,496,1,1,0,0},nCount=1,nRate=0.02},
			{szName="M∂nh Tµng B∂o ßÂ 8",tbProp={4,497,1,1,0,0},nCount=1,nRate=0.02},
			{szName="M∂nh Tµng B∂o ßÂ 9",tbProp={4,498,1,1,0,0},nCount=1,nRate=0.02},
			{szName="M∂nh Tµng B∂o ßÂ 10",tbProp={4,499,1,1,0,0},nCount=1,nRate=0.02},
			{szName="M∂nh Tµng B∂o ßÂ 11",tbProp={4,500,1,1,0,0},nCount=1,nRate=0.02},
			{szName="M∂nh Tµng B∂o ßÂ 12",tbProp={4,501,1,1,0,0},nCount=1,nRate=0.02},

			{szName = "ßi”m Kinh Nghi÷m", nExp=2000000,nRate=0.5},
			{szName = "ßi”m Kinh Nghi÷m", nExp=4000000,nRate=0.5},
			{szName = "ßi”m Kinh Nghi÷m", nExp=6000000,nRate=0.5},
			{szName = "ßi”m Kinh Nghi÷m", nExp=8000000,nRate=0.5},
			{szName = "ßi”m Kinh Nghi÷m", nExp=10000000,nRate=0.01},
			{szName = "ßi”m Kinh Nghi÷m", nExp=15000000,nRate=0.01},

			{szName = "L÷nh bµi hoµn thµnh D∑ T»u",tbProp={6,1,4336,1,0,0},nCount=1,nRate=0.1},
			{szName = "CËng Hi’n L‘ bao",tbProp={6,1,30214,1,0,0},nCount=1,nRate=0.02},
			{szName = "CËng Hi’n ßπi L‘ bao",tbProp={6,1,30215,1,0,0},nCount=1,nRate=0.01},
			{szName = "Ki’n Thi’t L‘ Bao",tbProp={6,1,30216,1,0,0},nCount=1,nRate=0.02},
			{szName = "Ki’n Thi’t ßπi L‘ Bao",tbProp={6,1,30217,1,0,0},nCount=1,nRate=0.01},
			{szName = "Chi’n Bﬁ L‘ Bao",tbProp={6,1,30218,1,0,0},nCount=1,nRate=0.02},
			{szName = "Chi’n Bﬁ ßπi L‘ Bao",tbProp={6,1,30219,1,0,0},nCount=1,nRate=0.01},

			{szName = "Ti™n th∂o lÈ ß∆c Bi÷t",tbProp={6,1,1181,1,0,0},nCount=1, nRate=1},
			{szName = "N’n B∏t tr©n phÛc nguy÷t", nRate = 0.5,   tbProp = {6, 1, 1817, 1, 0, 0}, nCount=1},	
			{szName = "Th≠ Æ∆c x∏ tri“u Æ◊nh", tbProp={6,1,1375,1,0,0},nCount=1, nRate =0.1},
			{szName = "Tˆ m…u l÷nh",tbProp={6,1,1427,1,0,0},nCount=1,nRate=0.1},

			{szName = "T›n s¯ y™u bµi", tbProp={6,1,888,1,0,0},nCount=1, nRate =0.05},
			{szName = "CÛc hoa thπch", tbProp={4,963,1,1,0,0},nCount=1, nRate =0.05},
			{szName = "B®ng thπch k’t tinh", tbProp={4,967,1,1,0,0},nCount=1, nRate =0.05},
			{szName = "B®ng thi“m t¨", tbProp={4,965,1,1,0,0},nCount=1, nRate =0.05},
			{szName = "K™ huy’t thπch", tbProp={4,966,1,1,0,0},nCount=1, nRate =0.05},
			{szName = "M∑ n∑o", tbProp={4,964,1,1,0,0},nCount=1, nRate =0.05},
			{szName = "M∂nh thi™n thπch", tbProp={4,968,1,1,0,0},nCount=1, nRate =0.05},
			{szName = "ßi“n hoµng thπch", tbProp={4,969,1,1,0,0},nCount=1, nRate =0.2},
	}
	tbAwardTemplet:Give(tbItemAward, 1 , {EVENT_LOG_TITLE, "SuDungNguThaiKetTinh"})
	--Diem kn dat moc
	local tbBonusAward = {
		[500] = {{szName = "ßi”m kinh nghi÷m kh´ng cÈng dÂn", nExp = 150000000},},
		[600] = {{szName = "ßi”m kinh nghi÷m kh´ng cÈng dÂn", nExp = 160000000},},
		[700] = {{szName = "ßi”m kinh nghi÷m kh´ng cÈng dÂn", nExp = 170000000},},
		[800] = {{szName = "ßi”m kinh nghi÷m kh´ng cÈng dÂn", nExp = 180000000},},
		[900] = 
		{
			{szName = "ßi”m kinh nghi÷m kh´ng cÈng dÂn", nExp = 190000000},
			{szName = "M∆t nπ V≠¨ng Gi∂", tbProp = {0,11,561,1,0,0}, nExpiredTime = 60*24*15, nCount=1},
			{szName = "Th t tinh th∂o", tbProp={6,1,1673,1,0,0},nCount=1, },
			{szName = "B∏ch ni™n th t tinh th∂o", tbProp={6,1,1674,1,0,0},nCount=1, },
			{szName = "Thi™n ni™n th t tinh th∂o", tbProp={6,1,1675,1,0,0},nCount=1, },
			{szName = "Bæc ß»u truy“n c´ng thuÀt", tbProp={6,1,1672,1,0,0},nCount=1, },
			{szName = "ßÂ phÊ Hoµng Kim - ßﬁnh QuËc § Sa Ph∏t Qu∏n",tbProp={6,1,384,1,0,0},nCount=2},
		},
		[1000] = 
		{
			{szName = "ßi”m kinh nghi÷m kh´ng cÈng dÂn", nExp_tl = 7000000000}, 
			{szName = "Nh t k˚ cµn kh´n phÔ",	tbProp = {6,1,2126,1,0,0},nCount=1,},
			{szName = "Huy“n tinh c p 8", tbProp={6,1,147,8,0,0},nCount=1,},
			{szName = "ßπi thµnh b› k›p 90",tbProp={6,1,2424,1,0,0},nCount=1},
			{szName = "NgÚ Hµnh K˙ Thπch",tbProp={6,1,2125,1,0,0},nCount=50,},
			{szName = "ßÂ phÊ Hoµng Kim - An Bang B®ng Tinh Thπch Hπng Li™n",tbProp={6,1,388,1,0,0},nCount=2},
		},
	}

	if tbBonusAward[nCurCount] then
		tbAwardTemplet:Give(tbBonusAward[nCurCount], 1 , {EVENT_LOG_TITLE, format("SuDung%dlanMamNguQua", nCurCount)})
		Msg2SubWorld("ChÛc mıng <color=yellow>"..GetName().."<color> sˆ dÙng Æ’n mËc <color=green>"..nCurCount.."<color> vÀt ph»m M©m ngÚ qu∂, nhÀn Æ≠Óc ph«n th≠Îng nh≠ ˝")
	end
	
end

function pActivity:TetND2016_BanhChungDacBiet()
	
	local tbExpAward = {
		[1] = {szName = "ßi”m kinh nghi÷m", nExp = 900000},
	}
	tbAwardTemplet:Give(tbExpAward, 1 , {EVENT_LOG_TITLE, "SuDungBanhChungDacBietMD"})

	local solansudung = self:GetTask(%TSK_SUDUNG_BANHCHUNG)
	solansudung = solansudung + 1
	Msg2Player("ß∑ sˆ dÙng: " .. solansudung .. " l«n")
end

function pActivity:TetND2016_BaoLiXi()
	local tbItemAward = 
	{
		{szName="ßi”m Kinh Nghi÷m cÈng dÂn", nExp_tl=random(100000000,200000000)},
	}
	tbAwardTemplet:Give(tbItemAward, 1 , {EVENT_LOG_TITLE, "SuDungBaoLiXiNam2016"})
	Msg2SubWorld("ChÛc mıng Æπi hi÷p <color=green>"..GetName().."<color> Æ∑ sˆ dÙng <color=yellow>Bao L◊ X◊ Mıng n®m mÌi<color> tπi npc ßπi Th«n Tµi (T≠¨ng D≠¨ng 198/201)")
end