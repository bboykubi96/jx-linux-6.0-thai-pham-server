Include("\\script\\missions\\tongwar\\match\\head.lua")

function main() 
oldSubWorld = SubWorld 
oldmapid = SubWorldIdx2ID(SubWorld) 

matchmap = tongwar_getmatchmap(oldmapid) 
mapidx = SubWorldID2Idx(matchmap) 
if (mapidx < 0) then 
return 
end 
LeaveTeam() 
SubWorld = mapidx 

if (GetMissionV(MS_STATE) == 0) then 
Say("Vâ l©m ®Ö nhÊt bang tranh tµi cßn ch­a b¾t ®Çu , xin chê mét chót ", 0) 
elseif (GetMissionV(MS_STATE) == 1) then 
Say("Phe ta tr­íc m¾t ®ang tËp häp chuÈn bÞ tiÕn vµo chiÕn tr­êng , xin mäi ng­êi an tÜnh , chuÈn bÞ xong tinh thÇn !", 0) 
elseif (GetMissionV(MS_STATE) == 2) then 
if (tongwar_checkjoin(oldmapid)) then 
SubWorld = oldSubWorld 
return 
end 
end 
SubWorld = oldSubWorld 
SetPos(1619,3175) 
end 

function tongwar_checkjoin(mapid) 
if (tongwar_getdata(TONGWAR_RLTASK_KEYNUMBER) ~= GetMissionV(MS_KEYNUMBER)) then 
tongwar_cleartask()-- script viet hoa By http://tranhba.com settask(ms_keynumber)-- script viet hoa By http://tranhba.com settask(maxdeath) 
end 
local tongname = GetTongName() 
local lgid = LG_GetLeagueObjByRole(10, tongname) 
if (lgid == 0 or lgid == nil) then 
return 
end 
local cityname = LG_GetLeagueInfo(lgid) 
local camp = LG_GetLeagueTask(10, cityname, TONGWAR_LGTASK_CAMP) 
if (camp == 1) then 
if (cityname == GetMissionS(MS_S_CITYNAME_S)) then 
if (not tongwar_signerror(camp, cityname)) then 
return 
end 
return tongwar_signup(camp) 
else 
Say("Ng­¬i liªn minh chuÈn bÞ khu kh«ng ë n¬i nµy , nhanh ®i minh chñ vâ l©m kia lùa chän chÝnh x¸c khu vùc ", 0) 
end 
elseif(camp == 2) then 
if (cityname == GetMissionS(MS_S_CITYNAME_J)) then 
if (not tongwar_signerror(camp, cityname)) then 
return 
end 
return tongwar_signup(camp) 
else 
Say("Ng­¬i liªn minh chuÈn bÞ khu kh«ng ë n¬i nµy , nhanh ®i minh chñ vâ l©m kia lùa chän chÝnh x¸c khu vùc ", 0) 
end 
else 
print("don't know the map"..mapid.." is which camp") 
end 
end 

function tongwar_signerror(camp, cityname) 
-- script viet hoa By http://tranhba.com VLDNB 10 - söa ®æi gia nhËp bang héi ®Ých thêi gian yªu cÇu - Modified by DinhHQ - 20111017 
if (GetJoinTongTime() < 1440) then 
Say("Gia nhËp bang héi thêi gian kh«ng ®ñ <color=red>1 ngµy <color>, kh«ng thÓ vµo ®Êu tr­êng .", 0) 
return 
end 
if (tongwar_getdata(TONGWAR_RLTASK_NDEATH) >= tongwar_getdata(TONGWAR_RLTASK_MAXDEATH)) then 
Say("Tö vong sè lÇn ®· v­ît qua "..tongwar_getdata(TONGWAR_RLTASK_MAXDEATH).." lÇn , kh«ng thÓ tiÕp tôc tham gia tranh tµi !", 0) 
return 
end 
if (GetMSPlayerCount(MISSIONID, camp) >= MAX_MEMBERCOUNT) then 
Say("Tr­íc m¾t ["..cityname.."] tham gia nh©n sè v­ît qua "..MAX_MEMBERCOUNT.." ng­êi , t¹m thêi kh«ng thÓ tham gia !", 0) 
return 
end 
return 1 
end 

function tongwar_signup(camp) 
if (tongwar_getdata(TONGWAR_RLTASK_KEYNUMBER) == GetMissionV(MS_KEYNUMBER)) then 
		tongwar_setdata(TONGWAR_RLTASK_NDEATH, tongwar_getdata(TONGWAR_RLTASK_NDEATH) + 1)
end 
BT_LeaveBattle() 
gametime = floor(GetMSRestTime(MISSIONID, 62) / 18); 

sf_mapid = SubWorldIdx2ID(SubWorld) 
if (camp == 1) then 
posx = GetMissionV(MS_HOMEIN_X1) 
posy = GetMissionV(MS_HOMEIN_Y1) 
EnterChannel(PlayerIndex, GetMissionS(MS_S_CITYNAME_S)) 
else 
posx = GetMissionV(MS_HOMEIN_X2) 
posy = GetMissionV(MS_HOMEIN_Y2) 
EnterChannel(PlayerIndex, GetMissionS(MS_S_CITYNAME_J)) 
end 

-- script viet hoa By http://tranhba.com BT_SetData(PL_PARAM1,0) 
-- script viet hoa By http://tranhba.com BT_SetData(PL_PARAM2,0) 
-- script viet hoa By http://tranhba.com Msg2Player("Tranh tµi tiÕn hµnh trung rêi s©n hoÆc h¹ tuyÕn , <color=yellow> ®Þch qu©n trËn doanh ®em ®¹t ®­îc 75 ph©n t­ëng th­ëng ") 
Msg2Player("§ang chiÕn ®Êu khu vùc , c¸i nµo liªn minh nh©n sè cña <color=yellow> Ýt h¬n so víi 5 ng­êi coi nh­ thua ") 
SetRevPos(GetPlayerRev()) -- script viet hoa By http://tranhba.com  thiÕt trÝ sèng l¹i ®iÓm v× th× ra lµ thµnh phè ®Ých sèng l¹i ®iÓm 
NewWorld(sf_mapid, posx, posy); 
tongwar_setdata(TONGWAR_RLTASK_KEYNUMBER, GetMissionV(MS_KEYNUMBER)) 
SetDeathType(-1) 
DisabledUseTownP(1) 
SetTempRevPos(sf_mapid, posx * 32, posy * 32); 
tongwar_setdata(TONGWAR_RLTASK_LASTDTIME, GetGameTime()) 
AddMSPlayer(MISSIONID,camp); 
BT_UpdateMemberCount(); 
SetCurCamp(camp); 
SetTaskTemp(200,1) 
SetFightState(0); 
SetLogoutRV(1); 
SetPunish(0); 
SetCreateTeam(0); 
SetPKFlag(1) 
ForbidChangePK(1); 
ForbidEnmity(1); 

BT_BroadView(); 
BT_BroadAllLadder(); 
BT_SetRestTime(gametime); 
BT_BroadGameData(); 
BT_SortLadder(); 
BT_BroadSelf() 
	SetDeathScript("\\script\\missions\\tongwar\\match\\playerdeath.lua");
bt_JudgePLAddTitle() 
return 1 
end 

function tongwar_cleartask() 
for i = TONGWAR_RLTASK_POINT, TONGWAR_RLTASK_MAXSERIESKILL do 
tongwar_setdata(i, 0) 
end 
tongwar_setdata(TV_SERIESKILL_REALY, 0) 
tongwar_setdata(TONGWAR_RLTASK_MAXDEATH, 10) 
BT_LeaveBattle() -- script viet hoa By http://tranhba.com  thanh trõ nhµ ch¬i kh¸ch hµng b­ng tr­íc mÆt ®Ých ®øng hµng sè liÖu 
BT_ClearPlayerData() 

end 

function tongwar_getmatchcamp(mapid) 
for i = 1, getn(tbTONGWARMAP) do 
if (mapid == tbTONGWARMAP[i][1] or mapid == tbTONGWARMAP[i][2] or mapid == tbTONGWARMAP[i][3]) then 
camp = i 
break 
end 
end 
return camp 
end 
