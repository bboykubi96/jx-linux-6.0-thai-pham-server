-- script viet hoa By http://tranhba.com  chøc n¨ng # trang bÞ [ hîp thµnh ] ch©n vèn ®Çu v¨n kiÖn # n¬i nµy [ hîp thµnh ] nãi vÒ nguyªn liÖu th¨ng cÊp # chÕ t¹o # v©y quanh chê tÊt c¶ t­¬ng quan thao t¸c # 
-- script viet hoa By http://tranhba.com  nãi râ # bæn v¨n mãn cung cÊp [ hîp thµnh ] thao t¸c mét lo¹i l­u tr×nh khu«ng gi¸ cïng mÊy t­¬ng quan chøc n¨ng hµm sè , cËn cung nh÷ng kh¸c cô thÓ [ hîp thµnh ] thao t¸c ch©n bæn v¨n mãn bao hµm sö dông 
-- script viet hoa By http://tranhba.com  bao hµm nªn v¨n kiÖn hoµn thµnh [ hîp thµnh ] chøc n¨ng , cÇn thùc hiÖn trë xuèng mÊy hµm sè cïng toµn côc thay ®æi l­îng # 
-- script viet hoa By http://tranhba.com  initData() # cã thÓ chän # míi b¾t ®Çu hãa sè liÖu 
-- script viet hoa By http://tranhba.com  getCompoundParam() lÊy ®­îc [ hîp thµnh ] thao t¸c tham sæ # dïng cho truyÒn l¹i cho ITEM_CalcItemValue tÝnh to¸n vËt phÈm gi¸ trÞ l­îng # 
-- script viet hoa By http://tranhba.com  verifySrcItems( arynNecessaryItemIdx, arynAlternativeItemIdx ) gi¸o nghiÖm nguyªn liÖu cã hay kh«ng phï hîp [ hîp thµnh ] quy t¾c # ®ång thêi tån tr÷ mét Ýt nguyªn liÖu sè liÖu # 
-- script viet hoa By http://tranhba.com  genDesItemsInfo( arynNecessaryItemIdx ) sinh thµnh môc tiªu vËt phÈm tin tøc 
-- script viet hoa By http://tranhba.com  vËt phÈm tin tøc kÕt cÊu #{ nItemVer, nRandSeed, nQuality, nGenre, nDetailType, nParticular, nLevel, nSeries, nLuck, {arynMagicLevel}, {arynMagicID}, strCompoundParam } 
-- script viet hoa By http://tranhba.com  function finalCompound( arynNecessaryItemIdx, arynAlternativeItemIdx, nSrcItemValSum, aryDesItemInfo, arydDesItemVal ) hoµn thµnh lùa chän môc tiªu vËt phÈm # thñ tiªu nguyªn liÖu chê kÕt thóc thao t¸c 
-- script viet hoa By http://tranhba.com  COMPOUND_COST [ hîp thµnh ] phÝ dông 
-- script viet hoa By http://tranhba.com  * nÕu nh­ vèn [ hîp thµnh ] l­u tr×nh khu«ng gi¸ khã chÞu dïng , lµ kh«ng bao hµm vèn ®Çu v¨n kiÖn , m×nh nÆng viÕt Compound tiÕp lêi hµm sè lµ ®­îc 
-- script viet hoa By http://tranhba.com  Fanghao Wu 2005.1.15 


IncludeLib( "ITEM" ); 
Include( "\\script\\item\\itemvalue\\itemvalue_header.lua" );


-- script viet hoa By http://tranhba.com  cÇn ghi chÐp Log ®Ých vËt phÈm 
ITEM_TO_LOG = 
{ 
{ 4, 238, 1, " lam thñy tinh " }, 
{ 4, 239, 1,"Tö thñy tinh " }, 
{ 4, 240, 1,"N­íc biÕc tinh " }, 
{ 6, 1, 122,"Phóc duyªn lé # tiÓu #" }, 
{ 6, 1, 123,"Phóc duyªn lé # trung #" }, 
{ 6, 1, 124,"Phóc duyªn lé # ®¹i #" }, 
{ 6, 1, 398,"ThÇn bÝ qu¸ng th¹ch " }, 
} 


-- script viet hoa By http://tranhba.com  trë xuèng c¸c thao t¸c kÕt qu¶ trÞ gi¸ ph¶i cïng tr×nh tù trung GameDataDef.h trong FOUNDRY_RESULT_TYPE mai gi¬ trÞ gi¸ nhÊt nhÊt ®èi øng 
RESULT_UNKNOWN = -1; -- script viet hoa By http://tranhba.com  kh«ng biÕt sai lÇm 
RESULT_SUCCEED = 0; -- script viet hoa By http://tranhba.com  [ hîp thµnh ] thµnh c«ng 
RESULT_FAIL = 1; -- script viet hoa By http://tranhba.com  [ hîp thµnh ] thÊt b¹i 
RESULT_NO_MONEY = 2; -- script viet hoa By http://tranhba.com  kim tiÒn ch­a ®ñ 
RESULT_LEVEL_FULL = 3; -- script viet hoa By http://tranhba.com  nguyªn liÖu ®· ®¹t tíi ®¼ng cÊp cao nhÊt 
RESULT_LACK_RESOURCE = 4; -- script viet hoa By http://tranhba.com  nguyªn liÖu ch­a ®ñ 
RESULT_LEVEL_ERROR = 5; -- script viet hoa By http://tranhba.com  nguyªn liÖu cÊp bËc sai lÇm 
RESULT_MAGIC_ERROR = 6; -- script viet hoa By http://tranhba.com  nguyªn liÖu ma ph¸p trÞ gi¸ sai lÇm 
RESULT_SERIES_ERROR = 7; -- script viet hoa By http://tranhba.com  nguyªn liÖu ngò hµnh sai lÇm 
RESULT_RULE_ERROR = 8; -- script viet hoa By http://tranhba.com  nguyªn liÖu kh«ng phï hîp quy t¾c 


GLBID_LAST_CMP_DATE = 32; -- script viet hoa By http://tranhba.com  toµn côc thay ®æi l­îng ID of mét lÇn cuèi cïng [ hîp thµnh ] ®Ých nhËt kú 
GLBID_COMMON_VAL_SUM = 33; -- script viet hoa By http://tranhba.com  toµn côc thay ®æi l­îng ID of vËt phÈm b×nh th­êng gi¸ trÞ l­îng hèi tæng trÞ gi¸ 
GLBID_GOLD_VAL_SUM = 34; -- script viet hoa By http://tranhba.com  toµn côc thay ®æi l­îng ID of hoµng kim trang bÞ gi¸ trÞ l­îng hèi tæng trÞ gi¸ 

SUM_UNIT = 10000000; -- script viet hoa By http://tranhba.com  tån tr÷ ®Õn GlobalValue ®Ých ®¬n vÞ # ngµn v¹n # 
COMMON_SUM_BASE_VAL = 100000000 / SUM_UNIT; -- script viet hoa By http://tranhba.com  cÇn kÕ vµo vËt phÈm b×nh th­êng gi¸ trÞ l­îng hèi tæng trÞ gi¸ ®Ých gi¸ trÞ thÊp nhÊt l­îng 
COMMON_SUM_MAX_VAL = 200000000000 / SUM_UNIT; -- script viet hoa By http://tranhba.com  mçi ngµy cho phÐp [ hîp thµnh ] ®Ých vËt phÈm b×nh th­êng gi¸ trÞ l­îng hèi tæng trÞ gi¸ ®Ých lín nhÊt trÞ gi¸ , tíi nµy trÞ gi¸ ®em kh«ng hÒ n÷a cho phÐp tiÕn hµnh bÊt kú [ hîp thµnh ] thao t¸c 
GOLD_SUM_BASE_VAL = 1000000000 / SUM_UNIT; -- script viet hoa By http://tranhba.com  cÇn kÕ vµo hoµng kim trang bÞ gi¸ trÞ l­îng hèi tæng trÞ gi¸ ®Ých gi¸ trÞ thÊp nhÊt l­îng 
GOLD_SUM_MAX_VAL = 200000000000 / SUM_UNIT; -- script viet hoa By http://tranhba.com  mçi ngµy cho phÐp [ hîp thµnh ] ®Ých hoµng kim trang bÞ gi¸ trÞ l­îng hèi tæng trÞ gi¸ ®Ých lín nhÊt trÞ gi¸ , tíi nµy trÞ gi¸ ®em kh«ng hÒ n÷a cho phÐp tiÕn hµnh bÊt kú [ hîp thµnh ] thao t¸c 


-- script viet hoa By http://tranhba.com  chøc n¨ng # bÞ tr×nh tù pháng vÊn ®Ých tiÕp lêi hµm sè , thùc hiÖn mét [ hîp thµnh ] thao t¸c 
-- script viet hoa By http://tranhba.com  tham sæ #arynNecessaryItemIdx nhÊt ®Þnh ph¶i nguyªn liÖu ®Ých vËt phÈm t¸c dÉn ®Õm tæ 
-- script viet hoa By http://tranhba.com  arynAlternativeItemIdx cã thÓ chän nguyªn liÖu ®Ých vËt phÈm t¸c dÉn ®Õm tæ 
-- script viet hoa By http://tranhba.com  bPreview dù l·m 
-- script viet hoa By http://tranhba.com  trë vÒ # sinh thµnh vËt phÈm t¸c dÉn , [ hîp thµnh ] kÕt qu¶ 
function Compound( arynNecessaryItemIdx, arynAlternativeItemIdx, bPreview ) 
-- if( isCompoundableToday() ~= 1 ) then 
-- Say("ThÇn bÝ thî rÌn # l·o phu vèn ngµy ®· kiÖt søc , hiÖp sÜ cßn lµ ngµy mai trë l¹i chÕ t¹o trang bÞ ®i . ", 0 ); 
-- return -1, RESULT_FAIL; 
-- end 
-- script viet hoa By http://tranhba.com  míi b¾t ®Çu hãa sè liÖu 
if( initData ~= nil ) then 
initData(); 
end 
-- script viet hoa By http://tranhba.com  gi¸o nghiÖm nguyªn liÖu cã hay kh«ng phï hîp [ hîp thµnh ] quy t¾c # ®ång thêi tån tr÷ mét Ýt nguyªn liÖu sè liÖu # 
local nResult,nPer = verifySrcItems( arynNecessaryItemIdx, arynAlternativeItemIdx ); 
if( nResult ~= RESULT_SUCCEED ) then 
return -1, nResult; 
end 
-- script viet hoa By http://tranhba.com  tr¶ [ hîp thµnh ] phÝ dông 
if( COMPOUND_COST == nil or Pay( COMPOUND_COST ) ~= 1 ) then 
return -1, RESULT_NO_MONEY; 
end 
-- script viet hoa By http://tranhba.com  tÝnh to¸n tÊt c¶ nguyªn liÖu gi¸ trÞ l­îng tæng céng 
local nNecItemValSum = sumItemsVal( arynNecessaryItemIdx ); 
local nAltItemValSum = sumItemsVal( arynAlternativeItemIdx ); 
local dAltItemFinalVal = nAltItemValSum; 
if( sumMainItemVal ~= nil ) then 
nMainItemValSum = sumMainItemVal( arynNecessaryItemIdx ); 
dAltItemFinalVal = calcAltItemFinalVal( nMainItemValSum, nAltItemValSum ); 
end 
	local nSrcItemValSum = nNecItemValSum + dAltItemFinalVal;
-- script viet hoa By http://tranhba.com  Msg2Player( "<color=yellow>-- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -" ); 
-- script viet hoa By http://tranhba.com 	Msg2Player( "<color=gold>TotalSrcSum: "..nNecItemValSum.."+"..dAltItemFinalVal.."="..nSrcItemValSum );
-- script viet hoa By http://tranhba.com  Msg2Player( "<color=yellow>-- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -" ); 
-- script viet hoa By http://tranhba.com  sinh thµnh môc tiªu vËt phÈm tin tøc 
local aryDesItemInfo = genDesItemsInfo( arynNecessaryItemIdx ); 
-- script viet hoa By http://tranhba.com  tÝnh to¸n mçi môc tiªu vËt phÈm ®Ých gi¸ trÞ l­îng 
local arydDesItemVal = {}; 
local nDesItemCount = getn( aryDesItemInfo ); 
for i = 1, nDesItemCount do 
arydDesItemVal[i] = funitem_calcItemValue(aryDesItemInfo[i]); 
-- script viet hoa By http://tranhba.com Msg2Player( "<color=green>DesValue"..i..": "..arydDesItemVal[i] ); 
end 
-- script viet hoa By http://tranhba.com  Msg2Player( "<color=yellow>-- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -" ); 

if( bPreview == 1 ) then -- script viet hoa By http://tranhba.com  dù l·m [ hîp thµnh ] ®Ých tû lÖ thµnh c«ng 
if( previewProb ~= nil ) then 
previewProb( arynNecessaryItemIdx, arynAlternativeItemIdx, nSrcItemValSum, aryDesItemInfo, arydDesItemVal ); 
end 
return -1, RESULT_SUCCEED; 
else -- script viet hoa By http://tranhba.com  tiÕn hµnh [ hîp thµnh ] thao t¸c 
-- script viet hoa By http://tranhba.com  hoµn thµnh lùa chän môc tiªu vËt phÈm # thñ tiªu nguyªn liÖu chê kÕt thóc thao t¸c 
nResultDesItemIdx, nResult = finalCompound( arynNecessaryItemIdx, arynAlternativeItemIdx, nSrcItemValSum, aryDesItemInfo, arydDesItemVal,nPer ); 
-- script viet hoa By http://tranhba.com  trë vÒ sinh thµnh vËt phÈm t¸c dÉn , [ hîp thµnh ] kÕt qu¶ 
return nResultDesItemIdx, nResult; 
end 
end 

-- script viet hoa By http://tranhba.com  mét lo¹i kÕt thóc thao t¸c hµm sè # hoµn thµnh lùa chän môc tiªu vËt phÈm # thñ tiªu nguyªn liÖu chê kÕt thóc thao t¸c # 
function defFinalCompound( arynNecessaryItemIdx, arynAlternativeItemIdx, nSrcItemValSum, aryDesItemInfo, arydDesItemVal, funcTransItemVal ) 
if (funcTransItemVal == nil) then 
funcTransItemVal = TransItemVal; 
end 
local nSelDesItemIdx, arydDesItemProb, dDesItemProbSum = funcTransItemVal( nSrcItemValSum, arydDesItemVal ); 
if( nSelDesItemIdx > 0 ) then 
-- script viet hoa By http://tranhba.com  tÝch lòy mçi ngµy [ hîp thµnh ] ®Ých vËt phÈm gi¸ trÞ l­îng hèi tæng trÞ gi¸ 
local nDesItemValCut = floor( arydDesItemVal[nSelDesItemIdx] / SUM_UNIT ); 
if( aryDesItemInfo[nSelDesItemIdx][3] == 1 ) then 
if( nDesItemValCut >= GOLD_SUM_BASE_VAL ) then 
local nGoldEqVal = GetGlbValue( GLBID_GOLD_VAL_SUM ); 
				SetGlbValue( GLBID_GOLD_VAL_SUM, nGoldEqVal + nDesItemValCut );
				if( nGoldEqVal + nDesItemValCut >= GOLD_SUM_MAX_VAL ) then
					local strMsg = format( "[¾¯±¨] %s ½ñÈÕ[ºÏ³É]µÄ»Æ½ð×°±¸µÄ¼ÛÖµ×ÜÁ¿£¨%0.2fE£©£¬ÒÑ³¬¹ý¼ÛÖµ×ÜÁ¿¾¯±¨ãÐÖµ£¨%0.2fE£©£¬¿ÉÄÜ³öÏÖË¢ÎïÆ·ÏÖÏó£¬Çë¾¡¿ìÁªÏµÑÐ·¢²¿£¡£¡£¡", date( "%Y-%m-%d %H:%M:%S" ), ( nGoldEqVal + nDesItemValCut ) * SUM_UNIT / 100000000, GOLD_SUM_MAX_VAL * SUM_UNIT / 100000000 );

WriteLog( strMsg ); 
end 
end 
else 
if( nDesItemValCut >= COMMON_SUM_BASE_VAL ) then 
local nCommonItemVal = GetGlbValue( GLBID_COMMON_VAL_SUM ); 
				SetGlbValue( GLBID_COMMON_VAL_SUM, nCommonItemVal + nDesItemValCut );
				if( nCommonItemVal + nDesItemValCut >= COMMON_SUM_MAX_VAL ) then
				local strMsg = format( "[¾¯±¨] %s ½ñÈÕ[ºÏ³É]µÄ×ÏÉ«×°±¸Ïà¹ØÎïÆ·µÄ¼ÛÖµ×ÜÁ¿£¨%0.2fE£©£¬ÒÑ³¬¹ý¼ÛÖµ×ÜÁ¿¾¯±¨ãÐÖµ£¨%0.2fE£©£¬¿ÉÄÜ³öÏÖË¢ÎïÆ·ÏÖÏó£¬Çë¾¡¿ìÁªÏµÑÐ·¢²¿£¡£¡£¡", date( "%Y-%m-%d %H:%M:%S" ), ( nCommonItemVal + nDesItemValCut ) * SUM_UNIT / 100000000, COMMON_SUM_MAX_VAL * SUM_UNIT / 100000000 );

WriteLog( strMsg ); 
end 
end 
end 
writeCompoundLog( arynNecessaryItemIdx, arynAlternativeItemIdx, nSrcItemValSum, aryDesItemInfo[nSelDesItemIdx], arydDesItemVal[nSelDesItemIdx], arydDesItemProb[nSelDesItemIdx] ); 
removeItems( arynNecessaryItemIdx ); 
removeItems( arynAlternativeItemIdx ); 
local nResultDesItemIdx = addItemByInfo( aryDesItemInfo[nSelDesItemIdx] ); 
if( nResultDesItemIdx > 0 ) then 
return nResultDesItemIdx, RESULT_SUCCEED; 
else -- script viet hoa By http://tranhba.com  sinh thµnh vËt phÈm thÊt b¹i dÞ th­êng còng lµm thµnh ngÉu nhiªn thÊt b¹i , tèt nhÊt lµm ghi chÐp 
return -1, RESULT_FAIL; 
end 
else 
writeCompoundLog( arynNecessaryItemIdx, arynAlternativeItemIdx, nSrcItemValSum, nil, 0, 1 - dDesItemProbSum ); 
removeItems( arynNecessaryItemIdx ); 
removeItems( arynAlternativeItemIdx ); 
return -1, RESULT_FAIL; 
end 
end 

-- script viet hoa By http://tranhba.com  tÝnh to¸n vËt phÈm ®Õm tæ gi¸ trÞ l­îng tæng céng 
function sumItemsVal( arynItemIdx ) 
local nItemCount = getn( arynItemIdx ); 
local nItemValSum = 0; 
local nCurItemVal; 
local szType = getCompoundParam()
-- script viet hoa By http://tranhba.com  Msg2Player( "<color=yellow>-- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -- script viet hoa By http://tranhba.com -" ); 
-- if szType == "EQUIP_ENCHASE" or szType == "MAGIC_DISTILL1" or szType == "MAGIC_DISTILL2" or szType == "MAGIC_DISTILL3" or szType == "MAGIC_DISTILL4" or szType == "MAGIC_DISTILL5" or szType == "MAGIC_DISTILL6" then

	-- for i = 1, nItemCount do 
		-- nCurItemVal = ITEM_CalcItemValue( arynItemIdx[i], getCompoundParam() ) * 0.8; 

		-- nItemValSum = nItemValSum + nCurItemVal;
	-- end 
-- else
	for i = 1, nItemCount do 
		nCurItemVal = ITEM_CalcItemValue( arynItemIdx[i], getCompoundParam() ); 
		-- script viet hoa By http://tranhba.com  Msg2Player( "<color=yellow>Value"..i..": "..nCurItemVal ); 
		nItemValSum = nItemValSum + nCurItemVal;
	end 
-- end
-- script viet hoa By http://tranhba.com  Msg2Player( "<color=gold>ValueSum: "..nItemValSum ); 
return nItemValSum; 
end 

-- script viet hoa By http://tranhba.com  tõ nhµ ch¬i trªn ng­êi thñ tiªu chØ ®Þnh vËt phÈm ®Õm tæ trung ®Ých tÊt c¶ vËt phÈm 
function removeItems( arynItemIdx ) 
local nItemCount = getn( arynItemIdx ); 
for i = 1, nItemCount do 
if( arynItemIdx[i] ~= nil ) then 
RemoveItemByIndex( arynItemIdx[i] ); 
end 
end 
end 

-- script viet hoa By http://tranhba.com  cho nhµ ch¬i gia t¨ng chØ ®Þnh vËt phÈm tin tøc vËt phÈm 
function addItemByInfo( iteminfo ) 
local nItemIdx; 
if( iteminfo[10] ~= nil ) then 
nItemIdx = AddItemEx( iteminfo[1], iteminfo[2], iteminfo[3], iteminfo[4], iteminfo[5], iteminfo[6], iteminfo[7], iteminfo[8], iteminfo[9], iteminfo[10][1], iteminfo[10][2], iteminfo[10][3], iteminfo[10][4], iteminfo[10][5], iteminfo[10][6] ); 
else 
nItemIdx = AddItemEx( iteminfo[1], iteminfo[2], iteminfo[3], iteminfo[4], iteminfo[5], iteminfo[6], iteminfo[7], iteminfo[8], iteminfo[9], 0 ); 
end 
if( nItemIdx > 0 ) then 
WriteCompoundLog( format( "DES_RANDSEED:\t%0.0f\tDES_GEN_TIME:\t%0.0f\r\n", ITEM_GetItemRandSeed( nItemIdx ), GetItemGenTime( nItemIdx ) ) ); 
else 
WriteCompoundLog( format( "ADD_ITEM_BY_INFO FAILED:\t{%d,%d,%d,%d,%d,%d,%d,%d,%d}\r\n", iteminfo[1], iteminfo[2], iteminfo[3], iteminfo[4], iteminfo[5], iteminfo[6], iteminfo[7], iteminfo[8], iteminfo[9] ) ); 
end 
return nItemIdx; 
end 

-- script viet hoa By http://tranhba.com  viÕt [ hîp thµnh ] ngµy chÝ 
function writeCompoundLog( arynNecessaryItemIdx, arynAlternativeItemIdx, nSrcItemValSum, desItemInfo, dDesItemVal, dDesProb ) 
local arystrSrc = { "", "" }; 
local arynItemIdx = { arynNecessaryItemIdx, arynAlternativeItemIdx }; 
for i = 1, 2 do 
for j = 1, getn( arynItemIdx[i] ) do 
local nGenre, nDetailType, nParticular, nLevel, nSeries, nLuck = GetItemProp( arynItemIdx[i][j] ); 
local nQuality = GetItemQuality( arynItemIdx[i][j] ); 
local arynMagLvl = GetItemAllParams( arynItemIdx[i][j] ); 
local nStackCount = GetItemStackCount( arynItemIdx[i][j] ); 
arystrSrc[i] = arystrSrc[i]..format( "{%d, %d, %d, %d, %d, %d, %d, <%d, %d, %d, %d, %d, %d>}#%d\t", nQuality, nGenre, nDetailType, nParticular, nLevel, nSeries, nLuck, arynMagLvl[1], arynMagLvl[2], arynMagLvl[3], arynMagLvl[4], arynMagLvl[5], arynMagLvl[6], nStackCount ); 
end 
end 
local strDes = ""; 
local strResult = ""; 
if( desItemInfo ~= nil ) then 
strResult = "SUCCEED"; 
if( desItemInfo[10] ~= nil ) then 
strDes = format( "{%d,%d,%d,%d,%d,%d,%d,<%d,%d,%d,%d,%d,%d>}", desItemInfo[3], desItemInfo[4], desItemInfo[5], desItemInfo[6], desItemInfo[7], desItemInfo[8], desItemInfo[9], desItemInfo[10][1], desItemInfo[10][2], desItemInfo[10][3], desItemInfo[10][4], desItemInfo[10][5], desItemInfo[10][6] ); 
else 
strDes = format( "{%d,%d,%d,%d,%d,%d,%d,<%d,%d,%d,%d,%d,%d>}", desItemInfo[3], desItemInfo[4], desItemInfo[5], desItemInfo[6], desItemInfo[7], desItemInfo[8], desItemInfo[9], 0, 0, 0, 0, 0, 0 ); 
end 
else 
strResult = "FAIL"; 
strDes = "NONE"; 
end 
WriteCompoundLog( format( "[%s]\t%s\t%s(%s)", getCompoundParam(), strResult, GetAccount( PlayerIndex ), GetName( PlayerIndex ) ) ); 
WriteCompoundLog( format( "SRC:\t%s", arystrSrc[1] ) ); 
WriteCompoundLog( format( "SRC_EX:\t%s", arystrSrc[2] ) ); 
WriteCompoundLog( format( "DES:\t%s", strDes ) ); 
WriteCompoundLog( format( "SRC_VAL_SUM:\t%0.0f\tDES_VAL:\t%0.0f\tDES_PROB:\t%0.2f%%", nSrcItemValSum, dDesItemVal, dDesProb*100 ) ); 
end 

-- script viet hoa By http://tranhba.com  ph¸n ®o¸n cã ®­îc hay kh«ng tiÕn hµnh [ hîp thµnh ] , tøc cßn ch­a tíi ®¹t ngµy ®ã [ hîp thµnh ] gi¸ trÞ tæng sè th­îng h¹n 
function isCompoundableToday() 
do return 1 end
local nLastDate = GetGlbValue( GLBID_LAST_CMP_DATE ); 
local nTodayString = tonumber( date( "%y%m%d" ) ); 
if( nLastDate ~= nTodayString ) then 
SetGlbValue( GLBID_LAST_CMP_DATE, nTodayString ); 
SetGlbValue( GLBID_COMMON_VAL_SUM, 0 ); 
SetGlbValue( GLBID_GOLD_VAL_SUM, 0 ); 
else 
local nCommonItemVal = GetGlbValue( GLBID_COMMON_VAL_SUM ); 
local nGoldEqVal = GetGlbValue( GLBID_GOLD_VAL_SUM ); 
if( nCommonItemVal >= COMMON_SUM_MAX_VAL or nGoldEqVal >= GOLD_SUM_MAX_VAL ) then 
return 0; 
end 
end 
return 1; 
end 

-- script viet hoa By http://tranhba.com  tÝnh to¸n cã thÓ chän vËt phÈm ®Ých bÞ [ hîp thµnh ] mÊu chèt vËt phÈm h¹n chÕ thªm quyÒn sau ®Ých gi¸ trÞ l­îng 
function calcAltItemFinalVal( nMainItemValSum, nAltItemValSum ) 
local dAltItemFinalVal = 0; 
local arySegmentScale = { { 0, 1 }, { 0.5, 0.9 }, { 1, 0.8 }, { 1.5, 0.7 }, { 2, 0.6 } }; 
local nSegmentCount = getn( arySegmentScale ); 
for i = nSegmentCount, 1, -1 do 
local nSegmentDiff = nAltItemValSum - nMainItemValSum * arySegmentScale[i][1]; 
if( nSegmentDiff > 0 ) then 
			dAltItemFinalVal = dAltItemFinalVal + nSegmentDiff * arySegmentScale[i][2];
nAltItemValSum = nAltItemValSum - nSegmentDiff; 
end 
end 
return dAltItemFinalVal; 
end 

function funitem_calcItemValue(aryDesItemInfo) 
return ITEM_CalcItemValue(aryDesItemInfo[1], aryDesItemInfo[3], aryDesItemInfo[4], aryDesItemInfo[5], aryDesItemInfo[6], aryDesItemInfo[7], aryDesItemInfo[8], aryDesItemInfo[9], aryDesItemInfo[10], aryDesItemInfo[11]) 
end
