Include("\\script\\battles\\battlehead.lua")
Include("\\script\\lib\\file.lua");
Include("\\script\\lib\\string.lua");
Include("\\script\\global\\forbidmap.lua");
Include("\\script\\missions\\sevencity\\war.lua")
Include("\\script\\global\\playerlist.lua")
Include("\\script\\item\\ib\\headshenxingfu.lua")
Include("\\script\\lib\\awardtemplet.lua")
Include("\\script\\global\\Ï´pkµÄÑÃÒÛ.lua")	--nhot tu
function main(sel)
	if GetTask(3003) == 10 then
		Say("Trong thêi gian ®ua top vËt phÈm nµy kh«ng cã t¸c dông. B¹n th«ng c¶m.")
		return
	end
	-- --dofile("script/missions/tifu/shenxingfu.lua");
	----dofile("script/item/ib/shenxingfu.lua");
	if auto_atone()==1 then
	return
	end
	if (IsDisabledUseTownP() == 1 or GetTaskTemp(200) == 1 ) or ( SubWorldIdx2ID( SubWorld ) >= 387 and SubWorldIdx2ID( SubWorld ) <= 395)then
		Msg2Player("Kh«ng thÓ sö dông thÇn hµnh phï!");
		return 1
	end
	
	local nSubWorldID = GetWorldPos();
	if (nSubWorldID >= 375 and nSubWorldID <= 386) then
		Msg2Player("Xin lçi, ®ang ë khu vùc ®Æc biÖt, kh«ng thÓ sö dông thÇn hµnh phï!");
		return 1
	end
	
	if (nSubWorldID >= 416 and nSubWorldID <= 511) then
		Msg2Player("Xin lçi, ®ang ë khu vùc ®Æc biÖt, kh«ng thÓ sö dông thÇn hµnh phï!");
		return 1
	end
	
	if (nSubWorldID == 44 or nSubWorldID == 197 or nSubWorldID == 208 or nSubWorldID == 209 or nSubWorldID == 210 or nSubWorldID == 211 or nSubWorldID == 212 or (nSubWorldID >= 213 and nSubWorldID <= 223)	or nSubWorldID == 336 or nSubWorldID == 341 or nSubWorldID == 342	or nSubWorldID == 175	or nSubWorldID == 337	or nSubWorldID == 338	or nSubWorldID == 339 or ( nSubWorldID >= 387 and  nSubWorldID <= 395 ) )then 
		Msg2Player("Xin lçi, ®ang ë khu vùc ®Æc biÖt, kh«ng thÓ sö dông thÇn hµnh phï!");
		return 1
	end;

	--ÎÀ¹úÕ½ÕùÖ®·é»ðÁ¬³ÇµØÍ¼£¬²»ÄÜÊ¹ÓÃ
	if (CheckAllMaps(nSubWorldID) == 1) then
		Msg2Player("Xin lçi, ®ang ë khu vùc ®Æc biÖt, kh«ng thÓ sö dông thÇn hµnh phï!");
		return 1
	end;
	
	if (GetLevel() < 5) then
		Say("LV5 trë lªn míi cã thÓ sö dông ThÇn Hµnh Phï!", 0);
		return 1
	end;
	
	Say("ThÇn Hµnh Phï cã thÓ thiÕt lËp ®Þa ®iÓm håi sinh,    cñng cã thÓ ®i ®Õn th«n trÊn hoÆc thµnh thÞ nµo ®ã", 6,
		-- "NhËn hç trî x2 kinh nghiÖm ®Õn cÊp 100/GetX2Skill",
		--"ThiÕt lËp ®iÓm håi sinh, lÇn sau nÕu ®¹i hiÖp sö dông thæ ®Þa phï sÏ ®Õn n¬i nµy/caba",
		"ThiÕt lËp ®iÓm håi sinh, lÇn sau nÕu ®¹i hiÖp sö dông thæ ®Þa phï sÏ ®Õn n¬i nµy/set_backpos", 
		"NhËn hç trî vßng s¸ng t©n thñ/AddHealPotion",
		"Sö dông thuËt thÇn hµnh cã thÓ ®­a ®¹i hiÖp ®Õn ®Þa ®iÓm chØ ®Þnh/chidi",
		-- "Mª cung KiÕm mé/cncm",
		 "Rêi khái/no" )
		--"È¥ÆäËûµØÍ¼/#tbVNGWORDPOS:GotoOtherMap()");
	return 1	
end;
function cncm()
-- Say("Chøc n¨ng nµy hiÖn ®ang hoµn thiÖn",0)
NewWorld(949, 50880 /32, 100736 /32)
end
function GetX2Skill()
local nLevel = GetLevel()
if nLevel >=100 then
Say("Hç trî chØ dµnh  cho ng­êi ch¬i cÊp d­íi 100")
return
end
AddSkillState(967,2,1,1555200)
Msg2Player("NhËn thµnh c«ng hç trî x2 exp.")
end
function AddPotion()
if GetLevel() >= 80 then
Say("CÊp 80 trë lªn ng­¬i ®· ®¸nh mÊt ®Æc ©n nµy råi. Th«ng c¶m.", 0);
return
end
if CalcFreeItemCellCount() < 30 then
	Say("H·y cÊt bít vËt phÈm ®Ó ®¶m b¶o cã 50 « trèng råi quay l¹i gÆp ta",0);
	return 1;
end
local tbAward={
{szName = "ThÊt khiÕu bæ t©m ®an",tbProp = {1,2,0,4,0,0},nBindState=-2,nCount=30},
}
tbAwardTemplet:GiveAwardByList(tbAward, "Nhan ho tro  mau tan thu")
end
function AddHealPotion()
if GetLevel() >= 100 then
Say("CÊp 100 trë lªn ng­¬i ®· ®¸nh mÊt ®Æc ©n nµy råi. Th«ng c¶m.", 0);
return
end
		AddSkillState(512,10,1,1555200)
		AddSkillState(527,3,1,1555200)
		AddSkillState(313,3,1,1555200)
		AddSkillState(314,10,1,1555200)
		AddSkillState(546,1,1,1555200)
		-- AddSkillState(440, 3, 1, 1555200); -- skill tien thao lo
		Talk(1, "", "B¹n sÏ ®­îc nhËn hæ trî kü n¨ng nµy ®Õn cÊp 100");
end
tab_RevivePos = {
	[1] = {	--"Thµnh §«"
		{"Cöa §«ng", 6, 11},{"Cöa T©y", 7, 11},{"Cöa Nam", 8, 11},{"Cöa B¾c", 9, 11},{"Trung T©m", 5, 11}
	},
	[2] = {	--"T­¬ng D­¬ng"
		{"Cöa §«ng", 30, 78},{"Cöa T©y", 32 , 78},{"Cöa Nam", 31, 78},{"Cöa B¾c", 33, 78},{"Trung T©m", 29, 78}
	},
	[3] = {	--"Ph­îng T­êng"
		{"Cöa §«ng", 1, 1},{"Cöa T©y", 2, 1},{"Cöa Nam", 3, 1},{"Cöa B¾c", 4, 1},{"Trung T©m", 0, 1}
	},
	[4] = {	--"§¹i Lý"
		{"Cöa B¾c", 64, 162},{"Trung T©m", 63, 162}
	},
	[5] = {	--"BiÖn Kinh"
		{"Cöa §«ng", 24, 37},{"Cöa T©y", 25, 37},{"Cöa Nam", 24, 37},{"Cöa B¾c", 26, 37},{"Trung T©m", 23, 37}
	},
	[6] = {	--"D­¬ng Ch©u"
		{"Cöa §«ng", 35, 80},{"Cöa T©y", 38, 80},{"Cöa Nam", 37, 80},{"Cöa B¾c", 36, 80},{"Trung T©m", 34, 80}
	},
	[7] = {	--"L©m An"
		{"Cöa §«ng", 68, 176},{"Cöa Nam", 67, 176},{"Cöa B¾c", 69, 176}
	},
	[8] = {	--"Th«n TrÊn"
		{"Ba L¨ng HuyÖn", 19, 53},{"Giang T©n Th«n", 10, 20},{"VÜnh L¹c TrÊn", 43, 99},{"Chu Tiªn TrÊn", 45, 100},{"§¹o H­¬ng Th«n", 47, 101},{"Long M«n TrÊn", 55, 121},{"Th¹ch Cæ TrÊn", 59, 153},{"Long TuyÒn Th«n", 65, 174}
	},
	[9] = {	--"M«n Ph¸i"
		{"Thiªn V­¬ng", 21, 59},{"ThiÕu L©m", 52, 103},{"§­êng M«n", 15, 25},{"Ngò §éc", 71, 183},{"Nga Mi", 13, 13},{"Thóy Yªn", 61, 154},{"Thiªn NhÉn", 28, 49},{"C¸i Bang", 53, 115},{"Vâ §ang", 40, 81},{"C«n L«n", 58, 131}
	},
};
--Éè¶¨ÖØÉúµã£¨Ñ¡³ÇÊÐ£©
function set_backpos()
	for i = 1, getn(tbBATTLEMAP) do 
		if ( nMapId == tbBATTLEMAP[i] ) then
			Msg2Player("Kh«ng thÓ sö dông ë ®©y!");
			return 1;
		end
	end	
	

	
	local tab_Content = {
		"Rêi khái/no",
		"  Thµnh §«/#setpos_step2(1)",
		"  T­¬ng D­¬ng/#setpos_step2(2)",
		"  Ph­îng T­êng/#setpos_step2(3)",
		"  §¹i Lý/#setpos_step2(4)",
		"  BiÖn Kinh/#setpos_step2(5)",
		"  D­¬ng Ch©u/#setpos_step2(6)",
		"  L©m An/#setpos_step2(7)",
		"  Th«n trÊn/#setpos_step2(8)",
		"  M«n ph¸i/#setpos_step2(9)"
		
	}
	Say("ThÇn Hµnh Phï, di chuyÓn ®Õn n¬i cÇn ®Õn.", getn(tab_Content), tab_Content);
end;

--Ñ¡µØµã
function setpos_step2(nIdx)
	local tab_Content = {};
	for i = 1, getn(tab_RevivePos[nIdx]) do
		tinsert(tab_Content, tab_RevivePos[nIdx][i][1].."/#setpos_step3( "..nIdx..","..i..")");
	end;
	tinsert(tab_Content, "Kh«ng ®i.../no");
	Say("ThÇn Hµnh Phï, di chuyÓn ®Õn n¬i cÇn ®Õn.", getn(tab_Content), tab_Content);
end;

--Ñ¡µØµã
function setpos_step3(nIdx, nSubIdx)
	SetRevPos(tab_RevivePos[nIdx][nSubIdx][3], tab_RevivePos[nIdx][nSubIdx][2]);
	Say("ThiÕt lËp ®Þa ®iÓm hßi sinh thµnh c«ng ë "..tab_RevivePos[nIdx][nSubIdx][1], 0);
	--Msg2Player("§· ®Õn "..tab_RevivePos[nIdx][nSubIdx][1]);
end;

--»Ø³Ç
function gototown()
	
	local tab_Content = {
		
		"§i ®Õn n¬i luyÖn c«ng/GoToTrainMap",
		"Thµnh thÞ/gopos_step2town",
		"Th«n trang/#gopos_step2(8)",
		"M«n ph¸i/#gopos_step2(9)",
		"Hoa S¬n Ph¸i/tth",
		"B¶n ®å cÊp 90/#gopos_step2lv90()",
		"ChiÕn tr­êng Tèng Kim/gopos_step2battle",
		"ChiÕn tr­êng ThÊt §¹i Thµnh ChiÕn/cncm",
		"  Rêi khái/no",
		
	}
	Say("ThÇn Hµnh Phï, di chuyÓn ®Õn n¬i cÇn ®Õn.", getn(tab_Content), tab_Content);
end;
-- function cncm()
-- Say("Chøc n¨ng nµy hiÖn ®ang hoµn thiÖn",0)
-- end
function tth()
if GetLevel() < 50 or GetCamp() == 0 or GetCurCamp() == 0 then
	Say("CÊp ®é qu¸ thÊp nh­ ng­¬i mµ còng muèn tham gia hay sao? VÒ nhµ luyÖn tËp thªm ®i")
	return
end
SetFightState(0)
NewWorld(333,1265,3262)
end
function chidi()
gototown()
end

function gopos_step2town()
	local tab_Content = {
		
		"Thµnh §«/#gopos_step2(1)",
		"T­¬ng D­¬ng/#gopos_step2(2)",
		"Ph­îng T­êng/#gopos_step2(3)",
		"§¹i Lý/#gopos_step2(4)",
		"BiÖn Kinh/#gopos_step2(5)",
		"D­¬ng Ch©u/#gopos_step2(6)",
		"L©m An/#gopos_step2(7)",
		"Kh«ng ®i./no"
	}
	Say("ThÇn Hµnh Phï, di chuyÓn ®Õn n¬i cÇn ®Õn.", getn(tab_Content), tab_Content);
end

--ÉñÐÐ·û£­£­£­£­µÚ¶þ²½
function gopos_step2(nIdx)
	local tab_Content = {};
	for i = 1, getn(tab_RevivePos[nIdx]) do
		tinsert(tab_Content, tab_RevivePos[nIdx][i][1].."/#gopos_step3( "..nIdx..","..i..")");
	end;
	tinsert(tab_Content, "Kh«ng ®i/no");
	Say("ThÇn Hµnh Phï, di chuyÓn ®Õn n¬i cÇn ®Õn.", getn(tab_Content), tab_Content);
end;

--ÉñÐÐ·û£­£­£­£­µÚÈý²½
function gopos_step3(nIdx, nSubIdx)
	local file = [[\settings\RevivePos.ini]];
	ini_loadfile(file, 0)
	local szData = ini_getdata(file, tab_RevivePos[nIdx][nSubIdx][3], tab_RevivePos[nIdx][nSubIdx][2]);

	local szArr = split(szData);
	local nPosX = floor(tonumber(szArr[1]) / 32);
	local nPosY = floor(tonumber(szArr[2]) / 32);
	
	if (not nPosX or not nPosY) then
		return
	end;
	NewWorld(tab_RevivePos[nIdx][nSubIdx][3], nPosX, nPosY)
	SetFightState(0);
	Msg2Player("Ngåi yªn! Chóng ta ®i!"..tab_RevivePos[nIdx][nSubIdx][1].."¿©");
end;


tab_lv90map = {
		{322,1589,3164	,"Tr­êng B¹ch S¬n B¾c",},
		{321,967,2313	,"Tr­êng B¹ch S¬n Nam",},
		{75,1811,3012	,"Xi V­u §éng Mª Cung",},
		{227,1588,3237	,"Sa M¹c Mª Cung 3",},
		{225,1474,3275	,"Sa M¹c Mª Cung 1",},
		{226,1560,3184	,"Sa M¹c Mª Cung 2",},
		{336,1124,3187	,"Phong L¨ng §é",},
		{340,1845,3438	,"M¹c Cao QuËt",},
		{144,1691,3020	,"D­îc V­¬ng §éng TÇng 4",},
		{93,1529,3166	,"TiÕn Cóc §éng MËt Cung",},
		{124,1675,3418	,"Hiªn Viªn §éng Mª Cung",},
		{152,1672,3361	,"TuyÕt B¸o §éng TÇng 8",},
        {917,1816,3392	,"Ph¸ch HuyÕt Cèc",},
		{918,1816,3392	,"Ác Nh©n Cèc",},
		{919,1608,3168	,"Thùc Cèt Nhai",},
		{920,1608,3168	,"H¾c Méc Nhai",},
		{921,1560,3104	,"Thiªn Phô S¬n",},
		{922,1560,3104	,"Bµn Long S¬n",},
		{923,2008,4080	,"§Þa MÉu S¬n",},
		{924,2008,4080	,"UyÓn Ph­îng S¬n",},
	}

function gopos_step2lv90(ns, ne)
	print(ns, ne)
	if (not ns) then
		ns_1 = 1;
		ne_1 = 7;
	else
		ns_1 = ns;
		ne_1 = ne;
	end
	
	if (ne_1 - ns_1 > 6) then
		ne_1 = ns_1 + 6;
	end
	
	local n_count = getn(tab_lv90map);
	
	local tab_Content = {};
	for i = ns_1, ne_1 do
		tinsert(tab_Content, tab_lv90map[i][4].."/#gopos_step3lv90( "..i..")");
	end
	
	if (ns_1 ~= 1) then
		tinsert(tab_Content, "Trang tr­íc/#gopos_step2lv90( 1,"..(ns_1-1)..")");
	end
	
	if (ne_1 < n_count) then
		tinsert(tab_Content, "Trang kÕ/#gopos_step2lv90( "..(ne_1+1)..","..n_count..")");
	end
	
	tinsert(tab_Content, "Hñy bá/no");
	Say("ThÇn Hµnh Phï, di chuyÓn ®Õn n¬i cÇn ®Õn.", getn(tab_Content), tab_Content);
end


function gopos_step3lv90(nIdx)
	local nW = tab_lv90map[nIdx][1]
	if (nW == 917 or  nW == 918 or  nW == 919 or  nW == 920 or  nW == 921 or  nW == 922 or  nW == 923 or  nW == 924) and GetTask(3203) <= 0 then
			Msg2Player("Thêi gian cßn l¹i cña b¹n ë b¶n ®å luyÖn c«ng ®· hÕt. Vui lßng gia h¹n b»ng vËt phÈm HiÖp hån sinh tö phï cã b¸n ë hµng rong c¸c thµnh thÞ",0)
			return
	end
	NewWorld(tab_lv90map[nIdx][1], tab_lv90map[nIdx][2], tab_lv90map[nIdx][3])
	SetFightState(1);
	Msg2Player("Ngåi yªn! Chóng ta ®i!"..tab_lv90map[nIdx][4].."!");
end


function gopos_step2battle()
	-- if ( GetLevel() < 120 ) then
		-- Talk( 1, "", "ChiÕn Tr­êng tµn khèc, ng­êi ch­a ®¹t ®Õn LV120, nªn ®õng cã ham hè :v" );
	-- else
		Say ( "Ng­¬i qu¶ thËt muèn ®Õn chiÕn tr­êng Tèng Kim?", 3, "Tèng qu©n ghi danh./#DoRescriptFunc(1)", "Kim qu©n ghi danh/#DoRescriptFunc(2)","À ê... ®Ó ta suy nghÜ l¹i./no" );
	-- end;
end

function gopos_sevencityfield()
	Say("ThÊt §¹i Thµnh ChiÕn, ng­êi muèn ®Õn n¬i nµo?", 8,
		"Thµnh §« chiÕn tr­êng/#goto_sevencityfield(1)",
		"T­¬ng D­¬ng chiÕn tr­êng/#goto_sevencityfield(2)",
		"Ph­îng T­êng chiÕn tr­êng/#goto_sevencityfield(3)",
		"§¹i Lý chiÕn tr­êng/#goto_sevencityfield(4)",
		"BiÖn Kinh chiÕn tr­êng/#goto_sevencityfield(5)",
		"D­¬ng Ch©u chiÕn tr­êng/#goto_sevencityfield(6)",
		"L©m An chiÕn tr­êng/#goto_sevencityfield(7)",
		"Th«i kh«ng ®i.../Cancel")
end

function goto_sevencityfield(nIndex)
	local player = PlayerList:GetPlayer(PlayerIndex)
	local tbErr = {}
	if (BattleWorld:CheckMapPermission(player, tbErr) == 0) then
		player:Say(tbErr.Msg)
		return
	end
	local nMapId = FIELD_LIST[nIndex]
	BattleWorld:Transfer(player, nMapId)
end

function DoRescriptFunc(nSel)
	-- if ( GetLevel() < 120 ) then
		-- Talk( 1, "", "ChiÕn Tr­êng tµn khèc, ng­êi ch­a ®¹t ®Õn LV120, nªn ®õng cã ham hè :v" );
		-- return
	-- end
	local tbsongjin_pos = {1541, 3178};	
	local szstr = "Tèng qu©n ghi danh.";
	if (nSel == 2) then
		tbsongjin_pos = {1570, 3085};
		szstr = "Kim qu©n ghi danh.";
	end;
	szstr = ""
	if ( GetLevel() >= 40 and GetLevel() < 80 ) then
		NewWorld( 323, tbsongjin_pos[1], tbsongjin_pos[2]);
		SetFightState(0);
		DisabledUseTownP(0); 
		Msg2Player( "ChiÕn Tr­êng S¬ cÊp" );
	elseif ( GetLevel() >= 80 and GetLevel() < 199 ) then
		NewWorld( 324, tbsongjin_pos[1], tbsongjin_pos[2]);
		SetFightState(0);
		DisabledUseTownP(0); 
		Msg2Player( "ChiÕn Tr­êng Trung cÊp" );
	else
		tbsongjin_pos=
		NewWorld( 325, tbsongjin_pos[1], tbsongjin_pos[2]);
		SetFightState(0);
		DisabledUseTownP(0); 
		Msg2Player( "ChiÕn Tr­êng Cao cÊp" );
	end
end
function GoToTrainMap()
local tbMsg = {
"Khu luyÖn c«ng 1x/#GotoWhere(1)",
"Khu luyÖn c«ng 2x/#GotoWhere(2)",
"Khu luyÖn c«ng 3x/#GotoWhere(3)",
"Khu luyÖn c«ng 4x/#GotoWhere(4)",
"Khu luyÖn c«ng 5x/#GotoWhere(5)",
"Khu luyÖn c«ng 6x/#GotoWhere(6)",
"Khu luyÖn c«ng 7x/#GotoWhere(7)",
"Khu luyÖn c«ng 8x/#GotoWhere(8)",
"Ta kh«ng r¶nh/no"
-- "Khu luyÖn c«ng 9x/#GotoWhere(1)",
-- "Khu luyÖn c«ng 1x/#GotoWhere(1)",
-- "Khu luyÖn c«ng 1x/#GotoWhere(1)",

}
Say("Ng­¬i muèn ®Õn ®©u nµo?",getn(tbMsg),tbMsg)
end
function GotoWhere(nIdx)
local nMapLvl = tonumber(nIdx)
if nMapLvl == 1 then
Talk(1,"no","Map luyÖn c«ng 1x lµ ë xung quanh c¸c thµnh thÞ vµ m«n ph¸i...")
return
end
nMapLvl = nMapLvl -1
local tbMsg = {
{"§Õn TÇn L¨ng/#TrainMap(1)","§Õn KiÕm c¸c thôc ®¹o/#TrainMap(2)"},
{"§Õn Thæ phØ ®éng/#TrainMap(3)","§Õn TÇn l¨ng tÇng 1/#TrainMap(4)"},
{"§Õn §iÒm th­¬ng ®éng tÇng 1/#TrainMap(5)","§Õn §iÒm th­¬ng ®éng tÇng 2/#TrainMap(6)"},
{"§Õn ThiÕt th¸p mª cung tÇng 1/#TrainMap(7)","§Õn Thiªn TÇm th¸p tÇng 1/#TrainMap(8)"},
{"§Õn Hoµnh S¬n Ph¸i/#TrainMap(9)","§Õn T­êng V©n ®éng tÇng 2/#TrainMap(10)"},
{"§Õn L©m du quan/#TrainMap(11)","§Õn §µo Hoa Nguyªn/#TrainMap(12)"},
{"§Õn Nh¹n th¹ch ®éng/#TrainMap(13)","§Õn Sa M¹c ®Þa biÓu/#TrainMap(14)","§Õn ch©n nói Tr­êng B¹ch/#TrainMap(15)"},
-- "Map luyÖn c«ng 1x lµ ë c¸c thµnh/no",
}
tbMsg[nMapLvl][getn(tbMsg[nMapLvl])+1] ="Ta chuÈn bÞ chót ®·/no"
Say("Ng­¬i muèn ®Õn ®©u ®Ó luyÖn? ",getn(tbMsg[nMapLvl]),tbMsg[nMapLvl])
-- Msg2Player(""..nIdx)
end
function TrainMap(nValue)
-- Msg2Player("Lua chon"..nValue)
local nOpt = tonumber(nValue)
local tbMapId = {
{7, 2235, 2847},--1
{19, 3084, 3975},--2
{170,1614,3189},--3
{8, 1603, 3497},--4
{171,1681,3104},--5
{172,1660,3080},--6
{38, 1602, 3206},--7
{164,1604,3197},
{56,1601, 3223},
{117,1640, 3152},
{319,1610,3610},
{55, 1592, 3184},
{10, 1603, 3209},
{224,1504,3120},
{320,144*8,142*16},
}
NewWorld(tbMapId[nOpt][1],tbMapId[nOpt][2],tbMapId[nOpt][3])
SetFightState(1)
end
function no()
end
