-- Tinh nang da tau edit by mcteam dong mo chuc nang

IncludeLib("FILESYS");
IncludeLib("RELAYLADDER");	--ÅÅÐÐ°ñ
Include("\\script\\task\\newtask\\tasklink\\tasklink_head.lua"); -- ÈÎÎñÁ´µÄÍ·ÎÄ¼þ
Include("\\script\\task\\newtask\\tasklink\\tasklink_award.lua"); -- ÈÎÎñÁ´µÄ½±ÀøÍ·ÎÄ¼þ
Include("\\script\\event\\storm\\function.lua")	--Storm
Include("\\script\\lib\\awardtemplet.lua")
Include("\\script\\lib\\log.lua")
Include("\\script\\activitysys\\g_activity.lua")
Include("\\script\\activitysys\\playerfunlib.lua")
Include("\\script\\global\\g7vn\\g7configall.lua")

function storm_goon_start(gameid, b_nonext)
	
	local nNum     = GetTask(ID_TASKLINK_LIMITNUM);
	
		nNum = nNum + 1;
		SetTask(ID_TASKLINK_LIMITNUM, nNum);
		
	if b_nonext then return end
	tl_dealtask()
	Task_MainDialog()
end

function checkTask_Limit()
	
local nNowDate = tonumber(GetLocalDate("%y%m%d"));
local nOldDate = GetTask(ID_TASKLINK_LIMITDATE);
local nNum     = GetTask(ID_TASKLINK_LIMITNUM);
local nTinvat = GetTask(3001)
	
	if nNowDate~=nOldDate then
		
		SetTask(ID_TASKLINK_LIMITDATE, tonumber(GetLocalDate("%y%m%d")) );
		SetTask(ID_TASKLINK_LIMITNUM, 0);
		SetTask(ID_TASKLINK_LIMITCancelCount, 0);
		SetTask(3001,0)
		return 1;
		
	else	
		
		if GetTask(3001) == 0 then

			if nNum >= 20 then
				Say("Ha! Ha! VÞ thiÕu hÞªp nµy! Mçi ngµy lµm 20 lÇn lµ ®ñ råi! Ngµy mai trë l¹i nhÐ!", 0);
				return 0;
			end;
		
			

		end

		if GetTask(3001) == 1 then

			if nNum >= 25 then
				Say("Ha! Ha! VÞ thiÕu hÞªp nµy! Mçi ngµy lµm 25 lÇn lµ ®ñ råi! Ngµy mai trë l¹i nhÐ!", 0);
				return 0;
			end;
		
			
		end
		if GetTask(3001) == 2 then

			if nNum >= 30 then
				Say("Ha! Ha! VÞ thiÕu hÞªp nµy! Mçi ngµy lµm 30 lÇn lµ ®ñ råi! Ngµy mai trë l¹i nhÐ!", 0);
				return 0;
			end;
		end
		if GetTask(3001) == 3 then

			if nNum >= 35 then
				Say("Ha! Ha! VÞ thiÕu hÞªp nµy! Mçi ngµy lµm 35 lÇn lµ ®ñ råi! Ngµy mai trë l¹i nhÐ!", 0);
				return 0;
			end;
		end
		
				if GetTask(3001) == 4 then

			if nNum >= 40 then
				Say("Ha! Ha! VÞ thiÕu hÞªp nµy! Mçi ngµy lµm 40 lÇn lµ ®ñ råi! Ngµy mai trë l¹i nhÐ!", 0);
				return 0;
			end;
		end
				
		return 1;

	end;
	
end;
	
	
--Task_BuyGoods = {}
--Task_FindGoods = {}
--Task_ShowGoods = {}
--Task_FindMaps = {}
--Task_UpGround = {}
--Task_WorldMaps = {}
--Task_Level = {}
--Task_MainLevelRate = {}


Task_BuyGoods = AssignValue(Task_BuyGoods,TL_BUYGOODS)
Task_FindGoods = AssignValue(Task_FindGoods,TL_FINDGOODS)
Task_ShowGoods = AssignValue(Task_ShowGoods,TL_SHOWGOODS)
Task_FindMaps = AssignValue(Task_FindMaps,TL_FINDMAPS)
Task_UpGround = AssignValue(Task_UpGround,TL_UPGROUND)
Task_WorldMaps = AssignValue(Task_WorldMaps,TL_WORLDMAPS)

Task_MainTaskLink = AssignValue_TaskLink(Task_MainTaskLink,TL_LEVELLINK)
Task_MainLevelRate = AssignValue_TaskRate(Task_MainLevelRate,TL_MAINTASKLEVEL)

Task_AwardBasic = AssignValue_Award(Task_AwardBasic,TL_AWARDBASIC)

Task_AwardLink = AssignValue_LinkAward(TL_AWARDLINK)

Task_AwardLoop = AssignValue_Award(Task_AwardLoop,TL_AWARDLOOP)

Task_TalkGoods = AssignValue_TaskTalk(Task_TalkGoods,TL_TASKGOODSTALK)
Task_TalkBuy = AssignValue_TaskTalk(Task_TalkBuy,TL_TASKBUYTALK)
Task_TalkShow = AssignValue_TaskTalk(Task_TalkShow,TL_TASKSHOWTALK)
Task_TalkFind = AssignValue_TaskTalk(Task_TalkFind,TL_TASKFINDMAPS)
Task_TalkUp = AssignValue_TaskTalk(Task_TalkUp,TL_TASKUPGROUNDTALK)
Task_TalkWorld = AssignValue_TaskTalk(Task_TalkWorld,TL_TASKWORLDTALK)

function logplayer(zFile,szMsg)
  local handle = openfile(zFile,"a")
  write(handle,format("%s\n",szMsg));
  closefile(handle);
 end


function Task_NewVersionAward()
	local nNum = GetTask(ID_TASKLINK_LIMITNUM);
	local nCancelNum = GetTask(ID_TASKLINK_LIMITCancelCount);
	DynamicExecuteByPlayer(PlayerIndex, "\\script\\huoyuedu\\huoyuedu.lua", "tbHuoYueDu:AddHuoYueDu", "yesourenwu")
	G_ACTIVITY:OnMessage("FinishYesou", nNum, nCancelNum);

	Msg2Player("§¹i hiÖp ®· hoµn thµnh <color=green>"..nNum.."<color> nhiÖm vô trong ngµy")
	Msg2Player("§¹i hiÖp ®· hñy bá <color=yellow>"..nCancelNum.."<color> nhiÖm vô trong ngµy")

	

	--Hoan thanh lien tiep 2 nv da tau khong huy xong nv thu 3 tan thu
	if (nNum - nCancelNum >= 2) then
		local tasknv1 = GetTask(idtaskgiftcodet92015)
		local tasknv2 = GetTask(idtaskCodetanthuG7nv2)
		local tasknv3 = GetTask(idtaskCodetanthuG7nv3)
		local tasknv4 = GetTask(idtaskCodetanthuG7nv4)
		local tasknv5 = GetTask(idtaskCodetanthuG7nv5)

		if tasknv1 == 1 and tasknv2 == 1 and tasknv3 == 0 and tasknv4 == 0 then
			local nlevel = GetLevel()
			local ntrungs = ST_GetTransLifeCount()
			SetTask(idtaskCodetanthuG7nv3,1)
			--if nlevel <99 and ntrungs == 0 then
			if nlevel < 79 then
				local lvthem = 79 - GetLevel()
				ST_LevelUp(lvthem)
				Msg2Player("Chóc mõng ®¹i hiÖp ®· <color=yellow>hoµn thµnh xong nhiÖm vô thø 3<color> trong chuçi nhiÖm vô t©n thñ, vÒ gÆp NPC Hç trî t©n thñ ®Ó xem nhiÖm vô tiÕp theo")
			end
		end
	end
	
	-----=== phan thuong da tau 20 nhiem vu lien tiep==========-----------
	local nNum = GetTask(ID_TASKLINK_LIMITNUM);
	local nCancelNum = GetTask(ID_TASKLINK_LIMITCancelCount);	
	
	if (nNum - nCancelNum) == 20 then
		tbAward = 
			{

	
			{szName="§iÓm Kinh NghiÖm",nExp = 200e6,nRate=70},
			{szName="MËt TÞch Kü N¨ng 150 CÊp 21",tbProp={6,1,4345,1,0,0},nCount=1,nRate=3},
			{szName="MËt TÞch Kü N¨ng 150 CÊp 22",tbProp={6,1,4346,1,0,0},nCount=1,nRate=1},
			--{szName="MËt TÞch Kü N¨ng 150 CÊp 23",tbProp={6,1,4371,1,0,0},nCount=1,nRate=1},
			{szName="Cµn kh«n song tuyÖt béi",tbProp={6, 1, 2219, 1, 1, 0},nCount=1,nRate=3},
			{szName="Tinh Ngäc",tbProp={6, 1, 4807, 1, 1, 0},nCount=random(20,50),nRate=4},
			
	
			}
		tbAwardTemplet:Give(tbAward, 1, {"DT", "test"})


		--logplayer("dulieu/moc20dt.txt"Thêi gian : %s  - Tµi kho¶n [ %s] - Nh©n vËt : [%s ] Da nhan moc 20 dt trong ngay ! ",GetIP(),GetLocalDate("%m/%d/%Y_%H:%M:%S"),GetAccount(),GetName()))

		Msg2SubWorld("Chóc mõng ®¹i hiÖp <color=green>"..GetName().."<color> hoµn thµnhl 20 nhiÖm vô d· tÈu trong ngµy <color> nhËn ®­îc  <color=yellow>NhiÒu phÇn th­ëng gi¸ trÞ<color>")
	end
	
	-----=== phan thuong da tau 40 nhiem vu lien tiep==========-----------
		local nNum = GetTask(ID_TASKLINK_LIMITNUM);
	local nCancelNum = GetTask(ID_TASKLINK_LIMITCancelCount);
	if (nNum - nCancelNum) == 40 then
		
		tbAwardTemplet:GiveAwardByList({{szName="MËt TÞch Kü N¨ng 150 CÊp 23",tbProp={6,1,4347,1,0,0},nCount=1,},}, "test", 1);	
		Msg2Player("H«m nay hoµn thµnh liªn tôc nhiÖm vô D· TÈu lÇn thø 40 liªn tiÕp kh«ng hñy , nhËn ®îc phÇn th­ëng!");

		


	end
	
end

-----------------------
	



function main()
	
	dofile("script/global/seasonnpc.lua");
	--dofile("script/global/g7vn/g7configall.lua")

	--do Say("HiÖn  t¹i dang dua top! tinh nang nay se duoc mo khi dua top xong") return end

	
	if GetLevel() < 170 then
		Say("§¼ng cÊp 170 trë lªn míi lµm nhiÖm vô d· tÈu .")
		return 1;

	end

	

	local nNum = GetTask(ID_TASKLINK_LIMITNUM);
	local nCancelNum = GetTask(ID_TASKLINK_LIMITCancelCount);

	Msg2Player("§¹i hiÖp ®· hoµn thµnh <color=green>"..nNum.."<color> nhiÖm vô trong ngµy")
	Msg2Player("§¹i hiÖp ®· hñy bá <color=yellow>"..nCancelNum.."<color> nhiÖm vô trong ngµy")

	local nDate = tonumber(GetLocalDate("%y%m%d"));
	if (nDate >= 60808 and nDate <= 60815) then
		local tab_Content = {
			"Xem cßn nhiÖm vô g× ®Ó lµm kh«ng/tasklink_entence",
		}
		tinsert(tab_Content, "Ta muèn lµm mét vßng Liªn Hoa/menglanjie");
		tinsert(tab_Content, "Rêi khái/Task_Wait");
		Say("MÊy n¨m nay chiÕn tranh triÒn miªn, d©n t×nh thèng khæ. Ph­¬ng tr­îng ThiÕu L©m tù muèn tæ chøc thä trai mõng LÔ Vu Lan ®Ó mäi ng­êi h­ëng chót gi©y phót yªn b×nh", getn(tab_Content), tab_Content);
		return
	end;
	
	tasklink_entence();
end;

function menglanjie()
	if (GetExtPoint(0) <= 0 or GetLevel() < 30) then
		Say("Xin lçi! ChØ cã ng­êi ch¬i tõ cÊp <color=red>30, ®· n¹p thÎ<color> míi cã thÓ tham gia ho¹t ®éng nµy", 0)
		return 
	end;
	local tab_Content = {
		"Ta muèn kÕt vßng Kim Liªn Hoa [cÇn 9 Kim Liªn Hoa]/#process(1)",
		"Ta muèn hîp thµnh vßng Méc Liªn Hoa [cÇn 9 Méc Liªn Hoa]/#process(2)",
		"Ta muèn hîp thµnh vßng Thñy Liªn Hoa [cÇn 9 Thñy Liªn Hoa]/#process(3)",
		"Ta muèn hîp thµnh vßng Háa Liªn Hoa [cÇn 9 Háa Liªn Hoa]/#process(4)",
		"Ta muèn hîp thµnh vßng Thæ Liªn Hoa [cÇn 9 Thæ Liªn Hoa]/#process(5)",
		"ChØ ®Õn th¨m «ng chót th«i!/Task_Wait"
	}
	Say("ChØ cÇn ng­¬i ®i thu thËp ®ñ sè Liªn Hoa vµ <color=yellow>"..MAKING_COST.."<color> l­îng ta sÏ gióp ng­¬i kÕt vßng hoa tuyÖt ®Ñp. Nh­ng l­u ý: mçi ngµy chØ cã thÓ kÕt ®­îc 2 vßng Liªn Hoa cïng thuéc tÝnh mµ th«i.", getn(tab_Content), tab_Content);
end;

--{name, product}
MAKING_COST = 10000;
MAKING_COUNT = 9;
tab_Flower = {
	{1126, "Kim", 1131, 1760, 1761}, {1127, "Méc", 1132, 1762, 1763}, {1128, "Thñy ", 1133, 1764, 1765}, {1129, "Háa", 1134, 1766, 1767}, {1130, "Thæ ", 1135, 1768, 1769}
}

function process(nIdx)
	if (nIdx < 1 or nIdx > getn(tab_Flower)) then
		return
	end;
	
	local nIndex;
	if (nIdx == 1) then
		nIndex = 1;
	elseif (nIdx == 2) then
		nIndex = 2;
	elseif (nIdx == 3) then
		nIndex = 3;
	elseif (nIdx == 4) then
		nIndex = 4;
	elseif (nIdx == 5) then
		nIndex = 5;
	end;
	
	Say("Muèn lµm 1 vßng <color=yellow>"..tab_Flower[nIdx][2].." Liªn Hoa<color> cÇn cã 9 <color=yellow>"..tab_Flower[nIdx][2].."Liªn Hoa<color>. Ng­¬i x¸c ®Þnh lµm chø?", 2, "§óng! Xin l·o bèi træ tµi!/#make_round("..nIndex..")", "Ta sÏ quay l¹i sau!/Task_Wait");
end;

function make_round(nIdx)
	if (GetCash() < MAKING_COST) then
		Say("Xin t×m ®ñ 10000 l­îng råi h·y quay l¹i! Ta ë ®©y chê!", 1, "§­îc th«i! Ta ®i lÊy thªm tiÒn!/Task_Wait");
		return
	end;
	
	local nCount = CalcEquiproomItemCount(6,1,tab_Flower[nIdx][1],-1);
	if (nCount < 9) then
		Say("Ng­¬i h×nh nh­ ch­a ®ñ <color=yellow>"..tab_Flower[nIdx][2].." Liªn Hoa<color=yellow>. Ch­a ®ñ 9 <color=yellow>"..tab_Flower[nIdx][2].." Liªn Hoa<color> th× ta kh«ng thÓ gióp ng­¬i kÕt vßng "..tab_Flower[nIdx][2].." Liªn Hoa hoµn", 1, "§Ó ta ®i chuÈn bÞ ®·!/Task_Wait");
		return
	end;
	
	local nDate = tonumber(GetLocalDate("%y%m%d"));
	if (nDate ~= GetTask(tab_Flower[nIdx][4])) then
		SetTask(tab_Flower[nIdx][4], nDate);
		SetTask(tab_Flower[nIdx][5], 0);
	end;
	
	local nTimes = GetTask(tab_Flower[nIdx][5]);
	if (nTimes >= 2) then
		Say(tab_Flower[nIdx][2].."H«m nay ®· kÕt thµnh c«ng 2 vßng råi! Mai h·y ®Õn nhÐ!", 0)
		return
	end;
	
	Pay(MAKING_COST);
	ConsumeEquiproomItem(9, 6, 1, tab_Flower[nIdx][1], -1);
	SetTask(tab_Flower[nIdx][5], nTimes + 1);
	AddItem(6, 1, tab_Flower[nIdx][3], 1, 0, 0, 0);
	Say("Vßng "..tab_Flower[nIdx][2].." Liªn Hoa cña ng­¬i ®· kÕt xong. H·y mang nã ®Õn chç LÔ Quan ®i!", 1, "NhËn vßng hoa/Task_Wait");
	Msg2Player("B¹n nhËn ®­îc mét"..tab_Flower[nIdx][2].." Liªn Hoa hoµn");
end;
    
function tasklink_entence()

_TaskLinkDebug() -- ¶ÔÓÚÈÎÎñÁ´ÎÞ·¨½øÐÐÏÂÈ¥µÄ BUG ÐÞ¸´

local myTaskTimes = tl_gettaskstate(1) -- Íæ¼Ò½øÐÐµ½µÄ´ÎÊý
local myTaskLinks = tl_gettaskstate(2) -- Íæ¼Ò½øÐÐµ½µÄÁ´Êý
local myTaskLoops = tl_gettaskstate(3) -- Íæ¼Ò½øÐÐµ½µÄ»·Êý
local myTaskCancel = tl_gettaskstate(4) -- Íæ¼Ò¿ÉÒÔÈ¡ÏûµÄ´ÎÊý

local myCountLinks
local myCountTimes

local myCanceled = nt_getTask(1036)
local myTaskTime = GetGameTime() -- »ñÈ¡ÓÎÏ·Ê±¼ä£¬ÓÃÒÔÅÐ¶ÏÍæ¼ÒÊÇ·ñ±»·â
local n = myTaskTime - nt_getTask(1029)
local myTaskInfo = ""


if (tl_gettaskcourse() == 2) then
	Task_GiveAward()
	return
end

	if ( myCanceled == 10) then
		if (n < 605) then
			Task_Punish()
			return
		else
			myCanceled = 0
			nt_setTask(1036,0)
			Task_Confirm()
		end
	end

	if (tl_gettaskcourse() == 0) then
		Say(" VÞ "..GetPlayerSex().." nµy xem ra ®· b«n ba giang hå ®­îc mét thêi gian dµi råi nhØ, cã muèn tham gia kh¶o nghiÖm nhiÖm vô liªn tôc cña ta kh«ng?",3,"§­îc th«i! Ta kh«ng tin cã nhiÖm vô nµo lµm khã dÔ ®­îc ta/Task_Confirm","Ta muèn biÕt kh¶o nghiÖm cña ng­¬i nãi cã néi dung ra sao/Task_Info","Ta bËn råi, kh«ng r¶nh ngåi t¸n gÉu víi «ng/Task_Exit");
	end
	
	if (tl_gettaskcourse() == 3) then

		if checkTask_Limit()~=1 then return end;
	
		myCountLinks = tl_counttasklinknum(2)
		myCountTimes = tl_counttasklinknum(1)
		Say(":<enter>VÞ "..GetPlayerSex().." ®· hoµn thµnh <color=yellow>"..myCountTimes.."<color>, nhiÖm vô nµy ngµy h«m nay cã thÓ thùc hiÖn l¹i<color=yellow>"..(40 - GetTask(ID_TASKLINK_LIMITNUM)).."<color>, ng­¬i cã muèn lµm n÷a kh«ng?",2,"§­¬ng nhiªn, mau cho ta biÕt nhiÖm vô tiÕp theo lµ g× /Task_TaskProcess","§Ó ta nghØ ng¬i mét l¸t ®·! Ta bËn råi/Task_Wait");
	elseif (tl_gettaskcourse() == 1) then
		Task_MainDialog()
	end

end

function Task_Confirm()

local myTaskID

tl_settaskstate(1,0) -- ÕýÔÚ½øÐÐµÚÒ»´ÎÈÎÎñ
tl_settaskstate(2,tl_getfirstlink()) -- ÕýÔÚ½øÐÐµÚÒ»Á´ÈÎÎñ
tl_settaskstate(3,tl_getfirstloop()) -- ÕýÔÚ½øÐÐµÚÒ»»·ÈÎÎñ

tl_settaskstate(4,0) -- Ê£Óà 0 ´ÎÈ¡ÏûÈÎÎñµÄ»ú»á
nt_setTask(DEBUG_TASKVALUE, 0);

tl_settaskstate(6,0)

storm_ask2start(4)	--Storm ¿ªÊ¼ÌôÕ½
tbLog:PlayerActionLog("TinhNangKey","NhanNhiemVuDaTau")
end

function Task_TaskProcess()

local myTaskTimes = tl_gettaskstate(1) -- Íæ¼Ò½øÐÐµ½µÄ´ÎÊý
local myTaskLinks = tl_gettaskstate(2) -- Íæ¼Ò½øÐÐµ½µÄÁ´Êý
local myTaskLoops = tl_gettaskstate(3) -- Íæ¼Ò½øÐÐµ½µÄ»·Êý
local myTaskCancel = tl_gettaskstate(4) -- Íæ¼Ò¿ÉÒÔÈ¡ÏûµÄ´ÎÊý

if checkTask_Limit()~=1 then return end;

tl_taskprocess() -- Ê×ÏÈÖ´ÐÐÏÂÒ»ÂÖº¯Êý

storm_goon_start()	--Storm»Ö¸´

end

function Task_MainDialog()

local myTaskInfo = tl_gettaskinfo() -- ÈÎÎñµÄÏêÏ¸ÐÅÏ¢
local myTaskTotalNum = tl_counttasklinknum(1) + 1; -- ×ÜÈÎÎñ´ÎÊýÍ³¼Æ
local myTitleText = "";

if (myTaskInfo == nil) then
	myTaskInfo = ""
end

tl_settaskcourse(1)


if myTaskTotalNum==0 or myTaskTotalNum==nil then
	myTitleText = "D· TÈu:<enter><enter>"..myTaskInfo;
else
	myTitleText = "D· TÈu:<enter><enter> §©y lµ <color=green>"..myTaskTotalNum.."<color> nhiÖm vô thø, "..myTaskInfo;
end;

Say(myTitleText,
	4,
	"BiÕt råi, ®Ó ta hoµn thµnh nhiÖm vô xong míi l¹i t×m ng­¬i/Task_Wait",
	"Ta ®· hoµn thµnh nhiÖm vô lÇn nµy, xin h·y kiÓm tra l¹i!/Task_Accept",
	--"Ta ®· hoµn thµnh nhiÖm vô lÇn nµy, xin h·y kiÓm tra l¹i!/Task_GiveAward",
	"NhiÖm vô lÇn nµy khã qu¸, Ta muèn hñy bá kh«ng lµm n÷a/Task_CancelConfirm",
	"Ta muèn biÕt kh¶o nghiÖm cña ng­¬i nãi cã néi dung ra sao/Task_Info"
	);

nt_setTask(1045, 1);

end


function Task_CancelConfirm()

local myTaskTimes = tl_gettaskstate(1) -- Íæ¼Ò½øÐÐµ½µÄ´ÎÊý
local myTaskLinks = tl_gettaskstate(2) -- Íæ¼Ò½øÐÐµ½µÄÁ´Êý
local myTaskLoops = tl_gettaskstate(3) -- Íæ¼Ò½øÐÐµ½µÄ»·Êý
local myTaskCancel = tl_gettaskstate(4) -- Íæ¼Ò¿ÉÒÔÈ¡ÏûµÄ´ÎÊý

local myCountTimes = tl_counttasklinknum(1);  -- Íæ¼Ò½øÐÐµÄÈÎÎñ×ÜÊý

if (myTaskCancel==0) then
	
	Say(" HiÖn t¹i b¹n kh«ng cã c¬ héi nµo ®Ó hñy bá nhiÖm vô, b¹n chØ cã thÓ lµm l¹i tõ ®Çu th«i! §ång thêi phÇn th­ëng tÝch lòy cña b¹n lóc tr­íc sÏ ®­îc tÝnh l¹i tõ ®Çu.",
		3,
		"§óng, ta kh«ng muèn lµm nhiÖm vô quû qu¸i nµy ®©u/Task_NormalCancel",
		"Ta muèn sö dông 100 m¶nh s¬n Hµ X· T¾c ®Ó hñy bá nhiÖm vô lÇn nµy/#Task_Cancel(2)",
		"Uhm! §Ó ta suy nghÜ l¹i ®·/Task_Wait");
	
else
	
	Say(" HiÖn t¹i b¹n cßn"..myTaskCancel.." sè lÇn c¬ héi hñy bá nhiÖm vô, b¹n x¸c ®Þnh hñy bá nhiÖm vô lÇn nµy ®óng kh«ng?",
		2,
		"§óng, ta kh«ng muèn lµm nhiÖm vô quû qu¸i nµy ®©u/#Task_Cancel(1)",
		"Uhm! §Ó ta suy nghÜ l¹i ®·/Task_Wait");
	
end

end

function Task_NormalCancel()

Say(" B¹n suy nghÜ kü hñy bá nhiÖm vô lÇn nµy ®óng kh«ng?",2,"§õng l«i th«i n÷a! ta kh«ng muèn lµm nhiÖm vô quû qu¸i nµy ®©u/#Task_Cancel(1)","Th«i ®Ó ta suy nghÜ l¹i ®·!/Task_Wait");

end;

-- 1000 
function Task_TotalCancel()
	GiveItemUI("Giao thñy tinh cho D· TÈu", "NÕu ng­¬i ®· quyÕt hñy bá chuçi nhiÖm vô, ta còng kh«ng ng¨n c¶n, h·y ®Æt vµo viªn Lôc Thñy Tinh!", "Task_TotalCancel_Main", "Task_Wait");
end;


function Task_TotalCancel_Main(nCount)
	
	local nGenre,nDetail,nParticular,nLevel,nGoodsFive,nLuck = 0,0,0,0,0,0;
	local nIndex = 0;
	
	if nCount~=1 then
		Say("D· TÈu: Ng­¬i ®­a g× cho ta vËy? Ta chØ cÇn <color=yellow>1 viªn Lôc Thñy Tinh<color> th«i!", 0);
		return
	end;
	
	nIndex = GetGiveItemUnit(1);
	nGenre,nDetail,nParticular,nLevel,nGoodsFive,nLuck = GetItemProp(nIndex);
	
	if nGenre==4 and nDetail==240 and nParticular==1 then
		Task_Cancel(1);  -- È«²¿È¡Ïû
	else
		Say("D· TÈu: Ng­¬i ®­a g× cho ta vËy? Ta chØ cÇn <color=yellow>1 viªn Lôc Thñy Tinh<color> th«i!", 0);
		return		
	end;
	
end;

function Task_ProcessInfo()

local myTaskTimes = tl_gettaskstate(1) -- Íæ¼Ò½øÐÐµ½µÄ´ÎÊý
local myTaskLinks = tl_gettaskstate(2) -- Íæ¼Ò½øÐÐµ½µÄÁ´Êý
local myTaskLoops = tl_gettaskstate(3) -- Íæ¼Ò½øÐÐµ½µÄ»·Êý
local myTaskCancel = tl_gettaskstate(4) -- Íæ¼Ò¿ÉÒÔÈ¡ÏûµÄ´ÎÊý

local myTaskType = tl_getplayertasktype()

local myTimes = tl_gettaskstate(1)
local myLinks = tl_gettaskstate(2)

local myCountTimes = tl_counttasklinknum(1)

-- local myTaskValue1 = tonumber(TabFile_GetCell(tl_gettasktextID(myTaskType),tl_gettasktablecol(),"TaskValue1"))
-- local myTaskValue2 = tonumber(TabFile_GetCell(tl_gettasktextID(myTaskType),tl_gettasktablecol(),"TaskValue2"))
	

-- local myMainValue = myTaskValue1 + (myTaskValue2 * (1+(myCountLinks+myTimes)*0.1))

-- local myMainValueText1 = "ÄãÄ¿Ç°µÄÈÎÎñÎïÆ·¼ÛÖµÎª: "..myTaskValue1.."  ÈÎÎñ¼ÛÖµÎª: "..myTaskValue2.."<enter>".."ÄãÏÖÔÚµÄÈÎÎñ×Ü¼ÛÖµÁ¿Îª: "..myMainValue

--	Say("Ò°ÛÅ£ºÄãÏÖÔÚ½øÐÐµ½ÁËµÚ "..myTaskLoops.." »·ÖÐµÄµÚ "..myTaskLinks.." Á´ÖÐµÄµÚ "..myTaskTimes.." ´Î¡£<enter>ÄãÁ¬Ðø½øÐÐµÄ´ÎÊýÎª£º"..tl_counttasklinknum(1).." ´Î<enter>ÄãÁ¬Ðø½øÐÐµÄÁ´ÊýÎª£º"..tl_counttasklinknum(2).." Á´<enter>"..myMainValueText1,0);

	Say(" HiÖn t¹i ng­êi ®· hoµn thµnh <color=yellow>"..myCountTimes.."<color> sè lÇn nhiÖm vô ta giao cho, cÇn cè g¾ng h¬n nhÐ!", 0);

end

function Task_Accept()
	if (CalcFreeItemCellCount() < 5) then
		Say("Hµnh trang ®· ®Çy, h·y s¾p xÕp l¹i cho ng¨n n¾p.",0);
		return
	end;
local myTaskType = tl_getplayertasktype()

	if (myTaskType == 1) then
		GiveItemUI("NhiÖm vô t×m vËt phÈm"," ña? Nh÷ng thø ta cÇn ng­¬i t×m ®­îc cho ta ch­a?","Task_Accept_01","Task_Wait");
	elseif (myTaskType == 2) then
		GiveItemUI("NhiÖm vô mua vËt phÈm"," ña? Nh÷ng thø ta cÇn ng­¬i t×m ®­îc cho ta ch­a?","Task_Accept_02","Task_Wait");
	elseif (myTaskType == 3) then
		GiveItemUI("NhiÖm vô hiÓn thÞ vËt phÈm"," ña? Nh÷ng thø ta cÇn ng­¬i t×m ®­îc cho ta ch­a?","Task_Accept_03","Task_Wait");
	elseif (myTaskType == 4) then
		Task_Accept_04()
	elseif (myTaskType == 5) then
		Task_Accept_05()
	elseif (myTaskType == 6) then
		Task_Accept_06()
	else -- Òì³£´¦Àí
		Say(" Nh÷ng thø ng­¬i giao cho ta ch­a ®¹t ®óng yªu cÇu, cè g¾ng h¬n nhÐ!",0);
	end

end

function Task_Accept_01(nCount)
local myTaskGoods
local ItemGenre,DetailType,ParticularType,Level,nSeries,Luck

if ( nCount > 1 ) then
	Say(" VÞ nµy"..GetPlayerSex()..", Ng­¬i bá nhiÒu ®å v« nh­ vËy xem tíi ta hoa c¶ m¾t, tõ tõ th«i nµo!",0);
	return 0
elseif ( nCount == 0) then
	Say(" VÞ nµy"..GetPlayerSex()..", ng­¬i cã thËt ®· bá vµo thø ta cÇn kh«ng? Kh«ng ph¶i l·o phu hoa m¾t chø?",0);
	return 0
end

	ItemGenre,DetailType,ParticularType,Level,nSeries,Luck = GetItemProp(GetGiveItemUnit(1))
--	magictype , p1, p2, p3 = GetItemMagicAttrib(nItemIndex, 1)
	myTaskGoods = {ItemGenre,DetailType,ParticularType,nSeries,Level}
	
--	tl_print ("Ò°ÛÅ¼ìÑéÁËÎïÆ·£º"..ItemGenre..DetailType..ParticularType..nSeries..Level)
	
	if (tl_checktask(myTaskGoods) == 1) then
		RemoveItemByIndex(GetGiveItemUnit(1)) -- É¾³ýÍæ¼ÒÉíÉÏµÄÎïÆ·
		Task_AwardRecord()
		Task_GiveAward()
		-- ·¢½±´¦Àí
	else
		Say(" Nh÷ng viÖc b¹n lµm ch­a ®¹t ®óng yªu cÇu, cè g¾ng h¬n nhÐ!",0);
	end
end

function Task_Accept_02(nCount)

local myTaskGoods
local ItemGenre, DetailType, ParticularType, Level, nSeries, Luck
local magictype,p1,p2,p3
local i,n,m = 0,0,0

if ( nCount > 1 ) then
	Say(" VÞ nµy"..GetPlayerSex()..", Ng­¬i bá nhiÒu ®å v« nh­ vËy xem tíi ta hoa c¶ m¾t, tõ tõ th«i nµo!",0);
	return 0
elseif ( nCount == 0) then
	Say(" VÞ nµy"..GetPlayerSex()..", ng­¬i cã thËt ®· bá vµo thø ta cÇn kh«ng? Kh«ng ph¶i l·o phu hoa m¾t chø?",0);
	return 0
end

	for i=1,6 do
		ItemGenre,DetailType,ParticularType,Level,nSeries,Luck = GetItemProp(GetGiveItemUnit(1))
		magictype , p1, p2, p3 = GetItemMagicAttrib(GetGiveItemUnit(1), i)
		myTaskGoods = {ItemGenre,DetailType,ParticularType,Level,nSeries,magictype,p1,p2,p3}
--		tl_print("¼ìÑéÁËÄ§·¨ÊôÐÔ "..i.." :".." Ä§·¨ ID Îª: "..magictype.."  Ä§·¨²ÎÊý1Îª: "..p1.."  Ä§·¨²ÎÊý2Îª: "..p2.." Ä§·¨²ÎÊý3Îª: "..p3);
		n = tl_checktask(myTaskGoods)
		if (n == 1) then
			m = 1
		end
	end
	
	if (m == 1) then
		RemoveItemByIndex(GetGiveItemUnit(1)) -- É¾³ýÍæ¼ÒÉíÉÏµÄÎïÆ·
		Task_AwardRecord()
		Task_GiveAward()
	else
		Say(" Nh÷ng viÖc b¹n lµm ch­a ®¹t ®óng yªu cÇu, cè g¾ng h¬n nhÐ!",0);
	end
	
end


function Task_Accept_03(nCount)

local myTaskGoods
local magictype,p1,p2,p3
local i,n,m = 0,0,0

if ( nCount > 1 ) then
	Say(" VÞ nµy"..GetPlayerSex()..", Ng­¬i bá nhiÒu ®å v« nh­ vËy xem tíi ta hoa c¶ m¾t, tõ tõ th«i nµo!",0);
	return 0
elseif ( nCount == 0) then
	Say(" VÞ nµy"..GetPlayerSex()..", ng­¬i cã thËt ®· bá vµo thø ta cÇn kh«ng? Kh«ng ph¶i l·o phu hoa m¾t chø?",0);
	return 0
end

	for i=1,6 do -- Ñ­»·Àú±éËùÓÐµÄÄ§·¨ÊôÐÔ¿´¿´ÊÇ·ñÓÐºÏÊÊµÄ
		magictype,p1,p2,p3 = GetItemMagicAttrib(GetGiveItemUnit(1),i)
		myTaskGoods = {magictype,p1,p2,p3}
		n = tl_checktask(myTaskGoods)
		if (n == 1) then
			m = 1
		end
	end	

	if (m == 1) then
		Task_AwardRecord()
		Task_GiveAward()
		-- ·¢½±´¦Àí
	else
		Say(" Nh÷ng viÖc b¹n lµm ch­a ®¹t ®óng yªu cÇu, cè g¾ng h¬n nhÐ!",0);
	end
	
end

function Task_Accept_04()

	if (tl_checktask() == 1) then
		Task_AwardRecord()
		Task_GiveAward()
		-- ·¢½±´¦Àí
	else
		Say(" Nh÷ng viÖc b¹n lµm ch­a ®¹t ®óng yªu cÇu, cè g¾ng h¬n nhÐ!",0);
	end
	
end

function Task_Accept_05()

	if (tl_checktask() == 1) then
		Task_AwardRecord()
		Task_GiveAward()
		-- ·¢½±´¦Àí
	else
		Say(" Nh÷ng viÖc b¹n lµm ch­a ®¹t ®óng yªu cÇu, cè g¾ng h¬n nhÐ!",0);
	end
	
end

function Task_Accept_06()
	
	if (tl_checktask()==1) then
		Task_AwardRecord()
		Task_GiveAward()
		return 1
	else
		Say(" Hahaha! VÞ nµy"..GetPlayerSex()..", ta tuy bÊt tµi, nh÷ng còng hiÓu ®­îc ch÷ tÝn trªn giang hå, ng­¬i cßn ch­a thu thËp ®ñ m¶nh s¬n Hµ X· T¾c mµ ta yªu cÇu sao cã thÓ ®Õn l·nh th­ëng ®©y?",0);
		return 0
	end

end

function Task_Cancel(nType)

local myTaskTimes = tl_gettaskstate(1) -- Íæ¼Ò½øÐÐµ½µÄ´ÎÊý

local myTaskLinks = tl_gettaskstate(2) -- Íæ¼Ò½øÐÐµ½µÄÁ´Êý
local myTaskLoops = tl_gettaskstate(3) -- Íæ¼Ò½øÐÐµ½µÄ»·Êý
local myTaskCancel = tl_gettaskstate(4) -- Íæ¼Ò¿ÉÒÔÈ¡ÏûµÄ´ÎÊý
local myCanceled = nt_getTask(1036) -- Íæ¼ÒÒÑ¾­¶ñÒâÈ¡ÏûÁË¶àÉÙ´Î
local myMapNum = nt_getTask(1027) -- ¿´¿´Íæ¼ÒÉíÉÏÓÐ¶àÉÙ¸öÉ½ºÓÉçð¢Í¼²ÐÆ¬

local myNewCancel = GetTask(DEBUG_TASKVALUE);  -- ±¸·ÝµÄÈ¡Ïû»ú»á

local nTotalTaskNum = tl_counttasklinknum(1); -- »ñÈ¡µ±Ç°Íæ¼ÒÒ»¹²×öÁË¶àÉÙ´ÎÈÎÎñ

if nt_getTask(1045)~=1 then
	return
end;

if _CancelTaskDebug()~=1 then
	Say("Uhm! B¹n trÎ nµy h×nh nh­ kh«ng cßn c¬ héi hñy bá ", 0);
	return
end;

if checkTask_Limit()~=1 then return end;

	if (nType==2) then
		if (myMapNum>=100) then
			myMapNum = myMapNum - 100;
			nt_setTask(1027, myMapNum);
			myTaskCancel = myTaskCancel + 1;
			Msg2Player("B¹n ®· sö dông 100 m¶nh s¬n Hµ X· T¾c ®Ó hñy bá nhiÖm vô nµy!");
			Msg2Player("M¶nh s¬n Hµ X· T¾c hiÖn t¹i cña b¹n cßn d­ "..myMapNum.." TÊm!");
		else
			Say(" ng­¬i cã ®óng ®· mang <color=yellow>100<color> m¶nh s¬n Hµ X· T¾c kh«ng? Ta cã nh×n lÇm kh«ng vËy?",0);
			return
		end;
	end;

	if (myTaskTimes == 0) and (myTaskLinks == tl_getfirstlink()) then
	
		if (myTaskCancel == 0) then
		
			myCanceled = myCanceled + 1
			nt_setTask(1036,myCanceled)
	
			if ( myCanceled > 2) then -- Èç¹ûÍæ¼ÒÁ¬ÐøÔÚ³õÆÚÈ¡ÏûÁËÈý´ÎÈÎÎñ£¬Ôò×÷´¦·£
				myCanceled = 10	
				nt_setTask(1036,myCanceled)
				nt_setTask(1029,GetGameTime())
				Task_Punish()
				
				return
				
			end
			
		end
		
		SetTask(ID_TASKLINK_LIMITCancelCount, GetTask(ID_TASKLINK_LIMITCancelCount) + 1); -- Ôö¼Óµ±ÌìµÄÈ¡Ïû´ÎÊý
		storm_ask2start(4)	--Storm ¿ªÊ¼ÌôÕ½
		
		return
		
	end

	if (myTaskCancel >= 1) then -- Èç¹ûÍæ¼Ò»¹ÓÐ»ú»áÈ¡ÏûµÄ»°Ôò¼ÌÐøËæ»úµ±Ç°µÈ¼¶µÄÈÎÎñ
	
		-- Ð´ÈëÈ¡ÏûÈÎÎñÊ±µÄ LOG
		_WriteCancelLog(nType, nTotalTaskNum, myTaskCancel);
		
		myTaskCancel = myTaskCancel - 1
		
		tl_settaskstate(4,myTaskCancel)
		
		nt_setTask(DEBUG_TASKVALUE, myTaskCancel);
			
	else
		-- Ð´ÈëÈ¡ÏûÈÎÎñÊ±µÄ LOG
		_WriteCancelLog(nType, nTotalTaskNum, myTaskCancel);
	
		tl_settaskstate(1,0) -- ÕýÔÚ½øÐÐµÚÒ»´ÎÈÎÎñ
		tl_settaskstate(2,tl_getfirstlink()) -- ÕýÔÚ½øÐÐµÚÒ»Á´ÈÎÎñ
		tl_settaskstate(3,0) -- ´ÓµÚ 0 »·¿ªÊ¼
		
		tl_settaskstate(4,0) -- Ê£Óà 0 ´ÎÈ¡ÏûÈÎÎñµÄ»ú»á
		nt_setTask(DEBUG_TASKVALUE, 0);
		
		tl_settaskstate(6,0) -- µ±Ç°µÄÁ´½øÐÐÁË 0 ´Î
		nt_setTask(1036,0) -- ³Í·£´ÎÊýÀÛ»ý±äÎª 0 
		-- ÔÚÕâÀï¼ÇÂ¼Ò»ÏÂÈÎÎñµÄ×ÜÊý
		nt_setTask(1044, tl_counttasklinknum(1));
		
		Msg2Player("<color=yellow>Chuçi nhiÖm vô D· TÈu ®· xãa bá hoµn toµn, b©y giê sÏ ph¶i lµm l¹i tõ nhiÖm vô ®Çu tiªn<color>!");
	end
	
	nt_setTask(1045, 2);
	
	SetTask(ID_TASKLINK_LIMITCancelCount, GetTask(ID_TASKLINK_LIMITCancelCount) + 1); -- Ôö¼Óµ±ÌìµÄÈ¡Ïû´ÎÊý
	storm_ask2start(4)	--Storm ¿ªÊ¼ÌôÕ½
end;


function Task_Info()
	Talk(4,
		"tasklink_entence",
		" LÇn nµy ta ®· s¾p xÕp c¸c lo¹i kh¶o nghiÖm nhiÖm vô nhá ®Ó thö th¸ch vâ thuËt còng nh­ tÝnh kiªn nhÉn cña c¸c vÞ anh hïng hµo kiÖt ®©y.",
		" Mçi lÇn hoµn thµnh nhiÖm vô ®Òu cã <color=red>phÇn th­ëng t­¬ng øng<color> cho c¸c vÞ, nÕu cã thÓ liªn tôc hoµn thµnh nhiÖm vô ®­îc ®Æt ra th× cã ®­îc <color=red>lÔ vËt tèt h¬n<color>d©ng tÆng riªng, nÕu nh­ ai ®ã cã thÓ ®¹t ®Õn <color=red>8000<color> nhiÖm vô sÏ nhËn ®­îc <color=red>sù ®Òn ®¸p ®Õn bÊt ngê<color>!",
		" NÕu nh­ ng­¬i bá qua mét nhiÖm vô trong sè nhiÖm vô th× tÝnh l¹i tõ nhiÖm vô ban ®Çu. Nh­ng mµ, ta cã lóc còng cho c¬ héi hñy bá nhiÖm vô, ®Ó xem ng­¬i n¾m b¾t ra sao th«i!",
		" Sao råi? Ng­êi thanh niªn cã muèn tiÕp nhËn sù kh¶o nghiÖm cña ta kh«ng?"
		);
end


function Task_Exit()

	if (GetSex() == 0) then
		Say(" Hahaha! §îi sau khi vÞ ®¹i hiÖp nµy th«ng qua kh¶o nghiÖm xong nhËn ®­îc c¸c phÇn th­ëng phong phó, tù nhiªn l¹i biÕt ®Õn t×m ta th«i!",0);
	else
		Say(" Hahaha! §îi sau khi vÞ n÷ hiÖp nµy th«ng qua kh¶o nghiÖm xong nhËn ®­îc c¸c phÇn th­ëng phong phó, tù nhiªn l¹i biÕt ®Õn t×m ta th«i!",0);
	end

end


function Task_Wait()

end


function Task_Punish()
	Say(" VÞ nµy"..GetPlayerSex().."Cã ph¶i gÊp l¾m kh«ng, kh¶o nghiÖm cña ta s¾p xÕp khã ®Õn nh­ vËy ­? LÇn sau ®Õn vËy!",0);
	return 0
end

function Task_GiveAward()

	local i
	
	local myAward
	local myLinkAward,myLoopAward
	
	local myGoodsText = ""
	local ShowText = {"","",""}

	-- local nTotalTaskNum = tl_counttasklinknum(1); -- »ñÈ¡µ±Ç°Íæ¼ÒÒ»¹²×öÁË¶àÉÙ´ÎÈÎÎñ
	-- if (nTotalTaskNum ~= 0 and mod(nTotalTaskNum, 10) == 0 and GetTask(TKS_TASKLINK_SPITEM) ~= nTotalTaskNum) then
		-- SetTask(TKS_TASKLINK_SPITEM, nTotalTaskNum);
		-- local tbItem = {tbProp = {6, 1, 2374, 1, 0, 0}}
		-- tbAwardTemplet:GiveAwardByList(tbItem, "seasonnpc_10task")
		-- Msg2Player(format("Chóc mõng ®¹i hiÖp ®· hoµn thµnh liªn tiÕp %d nhiÖm vô D· TÈu, nhËn ®­îc phÇn th­ëng %s!", 10, "B¶o r­¬ng thÇn bÝ cña D· TÈu"));
	-- end

	local nTongValue;
	myAward, nTongValue = tl_giveplayeraward(1);
	if (not nTongValue) then
		nTongValue = 0;
	end	
	local nBeishu = greatnight_huang_event(4);
	if (nBeishu > 0) then
		nTongValue = floor(nTongValue / nBeishu);
	end;
	
	for i=1,3 do
		if (myAward[i][1] == 1) then
			ShowText[i] = "NhËn ®­îc "..myAward[i][9].."/3".."/"..myAward[i][2].."/SelectAward_Money"
		elseif (myAward[i][1] == 2) then
			ShowText[i] = "NhËn ®­îc "..myAward[i][9].."/4".."/"..myAward[i][2].."/SelectAward_Exp"
		elseif (myAward[i][1] == 3) then
			myGoodsText = myAward[i][3]..","..myAward[i][4]..","..myAward[i][5]..","..myAward[i][6]..","..myAward[i][7]..","..myAward[i][8]
			ShowText[i] = "NhËn ®­îc "..myAward[i][9].."/5".."/"..myGoodsText.."/mySG"
		elseif (myAward[i][1] == 4) then
			if (myAward[i][10]==1) then
				myGoodsText = myAward[i][3]..","..myAward[i][4]..","..myAward[i][5]..","..myAward[i][6]..","..myAward[i][7]..","..myAward[i][8]
				ShowText[i] = myAward[i][9].."/6".."/"..myGoodsText.."/mySG"
			elseif (myAward[i][10]==2) then
				ShowText[i] = myAward[i][9].."/6".."/"..myAward[i][2].."/SelectAward_Exp"
			elseif (myAward[i][10]==3) then
				ShowText[i] = myAward[i][9].."/6".."/"..myAward[i][2].."/SelectAward_Money"
			end
			
		elseif (myAward[i][1] == 5) then
			ShowText[i] = "NhËn ®­îc "..myAward[i][9].."/7".."/"..myAward[i][1].."/SelectAward_Cancel"
		end
		
	end
	
	tl_print(ShowText[1])
	tl_print(ShowText[2])
	tl_print(ShowText[3])
	
	Prise( "Ng­¬i vÊt v¶ qu¸, xin mêi vÞ "..GetPlayerSex().." chän mãn m×nh thÝch ®i! ",ShowText[1],ShowText[2],ShowText[3] );
	
end

function Task_AwardRecord()
	--Storm ¼Ó»ý·Ö
	local filename = tl_gettasktextID(tl_getplayertasktype())
	local tabcol = tl_gettasktablecol()
	local myTaskValue1 = tonumber(TabFile_GetCell(filename,tabcol,"TaskValue1"))
	local myTaskValue2 = tonumber(TabFile_GetCell(filename,tabcol,"TaskValue2"))
	local myMainValue = myTaskValue1 + myTaskValue2
	storm_addpoint(4, myMainValue)
	
	tl_settaskcourse(2) -- ÈÎÎñµÄ½øÕ¹³Ì¶ÈÎª2£¬¼´ÊÇ»¹Ã»ÓÐ·¢½±
	nt_setTask(1037, GetGameTime() + tonumber(GetLocalDate("%H%M%S")));
end


function mySG(myQuality,myGenre,myDetail,myParticular,myLevel,myFive)

if (tl_gettaskcourse() == 3) then
	Say("Ng­¬i ®· l·nh th­ëng råi! §Þnh g¹t giµ nµy µ?",0);
	return
end

	if (CalcFreeItemCellCount() < 5) then
		Say("Hµnh trang ®· ®Çy, h·y s¾p xÕp l¹i cho ng¨n n¾p.",0);
		return
	end;
	
	if (myQuality == 0) then
		local nItemIndex =  AddItem(myGenre,myDetail,myParticular,myLevel,myFive,0,0)
		if (GetProductRegion() == "vn") then
			-- LLG_ALLINONE_TODO_20070802
			if (myDetail==238) or (myDetail==239) or (myDetail==240) or (myDetail==252) then
				WriteLog(" [Ghi nhí nhËn phÇn th­ëng]"..date(" [%y n¨m %m th¸ng %d ngµy  %H giê %M phót]")..": Tµi kho¶n"..GetAccount()..", nh©n vËt"..GetName().."Trong nhiÖm vô liªn tiÕp nhËn ®­îc phÇn th­ëng lµ b¶o th¹ch, sè thø tù lo¹i b¶o th¹ch lµ:"..myDetail)
			elseif (myGenre == 6 and myDetail == 1 and myParticular ==1475) then
				local nLastTime = FormatTime2Number(GetCurServerTime() + 7*24*60*60);
				local nYear = floor(nLastTime / 100000000);
				local nMMDD = mod(floor(nLastTime / 10000) , 10000);
				SetItemMagicLevel(nItemIndex, 1, GetTask(TSK_TASKLINK_SEANSONPOINT));
				SetItemMagicLevel(nItemIndex, 2, nYear);
				SetItemMagicLevel(nItemIndex, 3, nMMDD);
				SyncItem(nItemIndex);
				WriteLog(format("[Log phÇn th­ëng chuçi nhiÖm vô D· TÈu]%s: Tµi kho¶n %s, nh©n vËt %s hoµn thµnh chuçi nhiÖm vô D· TÈu nhËn ®­îc ®iÓm TÝch lòy D· TÈu (®iÓm kinh nghiÖm: %d)",
					date(" [%y n¨m %m th¸ng %d ngµy  %H giê %M phót]"),
					GetAccount(),
					GetName(),
					GetTask(TSK_TASKLINK_SEANSONPOINT)
				))
				SetTask(TSK_TASKLINK_SEANSONPOINT, 0);
			end
		else
			WriteLog(" [Ghi nhí nhËn phÇn th­ëng]"..date(" [%y n¨m %m th¸ng %d ngµy  %H giê %M phót]").." [mËt m·:"..GetAccount().."] [nh©n vËt:"..GetName().."]".."NhËn ®­îc 1 "..szName);
		end
	else
		AddGoldItem(0,myGenre)
		AddGlobalNews("Ng­êi ch¬i "..GetName().." ®· hoµn thµnh nhiÖm vô D· TÈu nªn ®· nhËn ®­îc 1 trang bÞ Hoµng Kim!!!");
		WriteLog(" [Ghi nhí nhËn phÇn th­ëng]"..date(" [%y n¨m %m th¸ng %d ngµy  %H giê %M phót]")..": Tµi kho¶n"..GetAccount()..", nh©n vËt"..GetName().."Trong nhiÖm vô liªn tiÕp nhËn ®­îc phÇn th­ëng lµ trang bÞ Hoµng Kim sè thø tù lµ:"..myGenre)
	end
	Msg2Player("B¹n nhËn ®­îc mét phÇn th­ëng nhiÖm vô!");
	
	tl_settaskcourse(3)
	PayPlayerLinkAward();
	
	local nBeishu = greatnight_huang_event(4);
	local nTongValueGift = GetTaskTemp(TASKID_TONG_TASKLINKTEMP);
	if (nBeishu > 0) then
		nTongValueGift = floor(nTongValueGift / nBeishu);
	end;
	tongaward_tasklink(nTongValueGift);	--¼ÓÉÏÃÅÅÉ½±Àø
	Task_NewVersionAward()
end

function SelectAward_Money(nAward)

if (tl_gettaskcourse() == 3) then
	Say("Ng­¬i ®· l·nh th­ëng råi! §Þnh g¹t giµ nµy µ?",0);
	return
end
	local nAward = nAward * 2
	Earn(nAward)
	Msg2Player("B¹n nhËn ®­îc <color=green>"..nAward.."<color> l­îng  b¹c");
	
	tl_settaskcourse(3)	
	PayPlayerLinkAward();
	
	if nAward>=300000 then
		WriteLog(" [Ghi nhí chuçi nhiÖm vô]"..
				 date(" [%y n¨m %m th¸ng %d ngµy  %H giê %M phót]")..
				 " [Tµi kho¶n]"..GetAccount()..
				 " [Nh©n vËt]"..GetName()..
				 "Trong nhiÖm vô liªn tiÕp nhËn ®­îc<money>"..nAward.."</money>phÇn th­ëng lµ l­îng b¹c!");
	end;
	local nBeishu = greatnight_huang_event(4);
	local nTongValueGift = GetTaskTemp(TASKID_TONG_TASKLINKTEMP);
	if (nBeishu > 0) then
		nTongValueGift = floor(nTongValueGift / nBeishu);
	end;
	tongaward_tasklink(nTongValueGift);	--¼ÓÉÏÃÅÅÉ½±Àø
	Task_NewVersionAward()
end


function SelectAward_Exp(nAward)
local nExp = 4318540
local nNum     = GetTask(ID_TASKLINK_LIMITNUM);
if nNum <= 4 then
	nAward = nExp + nExp  * (nNum + 1)
end
if nNum > 4 then
	nAward = nExp * nNum  + nExp * (nNum - 5)
end

if (tl_gettaskcourse() == 3) then
	Say("Ng­¬i ®· l·nh th­ëng råi! §Þnh g¹t giµ nµy µ?",0);
	return
end
	
	tl_addPlayerExp(nAward)
	Msg2Player("B¹n nhËn ®­îc <color=green>"..nAward.."<color> ®iÓm kinh nghiÖm");
	
	tl_settaskcourse(3)
	PayPlayerLinkAward();
	local nBeishu = greatnight_huang_event(4);
	local nTongValueGift = GetTaskTemp(TASKID_TONG_TASKLINKTEMP);
	if (nBeishu > 0) then
		nTongValueGift = floor(nTongValueGift / nBeishu);
	end;
	tongaward_tasklink(nTongValueGift);	--¼ÓÉÏÃÅÅÉ½±Àø
	Task_NewVersionAward()
end

function SelectAward_Change(nAward)

if (tl_gettaskcourse() == 3) then
	Say("Ng­¬i ®· l·nh th­ëng råi! §Þnh g¹t giµ nµy µ?",0);
	return
end

	Msg2Player("B¹n cã thªm c¬ héi nhËn ®­îc mét phÇn th­ëng ngÉu nhiªn!");
	
	tl_settaskcourse(3)
	PayPlayerLinkAward();

end

function SelectAward_Cancel(nAward)

local myCancel = 0;
local myNewCancel = GetTask(DEBUG_TASKVALUE);

	if (tl_gettaskcourse() == 3) then
		Say("Ng­¬i ®· l·nh th­ëng råi! §Þnh g¹t giµ nµy µ?",0);
		return
	end
	
	myCancel = tl_gettaskstate(4)
	myCancel = myCancel + 1
	
	if myNewCancel==0 then
		myNewCancel = myCancel;
	else
		myNewCancel = myNewCancel + 1;		
	end;
	
	if myNewCancel<=254 then

		nt_setTask(DEBUG_TASKVALUE, myNewCancel);
	end;
	
	tl_settaskstate(4, myCancel);
	
	if myCancel<=254 then
		Msg2Player("B¹n nhËn ®­îc <color=green>1 c¬ héi hñy bá nhiÖm vô<color>!");
	end;

	WriteLog(" [Ghi nhí nhËn phÇn th­ëng]"..
			 date(" [%yn¨m%mth¸ng%dngµy%Hgiê%Mphót%Sgi©y]")..
			 " [Tµi kho¶n]"..GetAccount()..
			 " [Nh©n vËt]"..GetName()..
			 "B¹n nhËn ®­îc c¬ héi hñy bá nhiÖm vô, hiÖn t¹i cßn cã thÓ c¬ héi hñy <"..myCancel.."> lÇn.");
	
	tl_settaskcourse(3)	
	PayPlayerLinkAward();
	
	local nBeishu = greatnight_huang_event(4);
	local nTongValueGift = GetTaskTemp(TASKID_TONG_TASKLINKTEMP);
	if (nBeishu > 0) then
		nTongValueGift = floor(nTongValueGift / nBeishu);
	end;
	tongaward_tasklink(nTongValueGift);	--¼ÓÉÏÃÅÅÉ½±Àø
	Task_NewVersionAward()
end


function PayPlayerLinkAward()

--local myGolden = {2,6,11,16,21,22,26,31,39,40,42,46,51,54,56,60,61,67,71,76,81,87,92,94,96,101,106,107,115,119,121,122,126,132,136,144,145,146} -- 20 »·½±Àø»Æ½ð×°±¸µÄ±àºÅ
local myGolden = {204,205,206,207,190,191,192,193,159,160,161,162,163,164,165,166,167} -- 20 »·½±Àø»Æ½ð×°±¸µÄ±àºÅ
local vkhkmp = {6,11,16,21,26,31,39,46,51,54,61,71,76,81,96,101,116,121,122,126} -- vu khi hkmp
local anban =  {6,11} -- trang bi an bang
local dinhquoc =  {6,11} -- trang bi dinhquoc
local hiepcot =  {6,11} -- trang bi hiep cot
local nhutinh =  {6,11} -- trang bi nhu tinh
local nGoldenID = 0

local myTaskTimes = tl_gettaskstate(1)
local myTaskLinks = tl_gettaskstate(2)
local myTaskLoops = tl_gettaskstate(3)

local nTotalTask = tl_counttasklinknum(1);

Ladder_NewLadder(10118, GetName(), nTotalTask, 1);

--nTotalTask = 100 --test so lan nhiem vu da tau

tl_getlinkaward(Task_AwardLink, nTotalTask);

if (nTotalTask == 8000) then
	nGoldenID = vkhkmp[random(getn(vkhkmp))]
	AddGoldItem( 0, nGoldenID )
	--WriteLog("[ÈÎÎñÁ´½±Àø¼ÇÂ¼]"..date("[%yÄê%mÔÂ%dÈÕ%HÊ±%M·Ö]").."£ºÕËºÅ"..GetAccount().."£¬½ÇÉ«"..GetName().."ÔÚÈÎÎñÁ´½±ÀøÖÐÒòÎªÍê³É 8000 ´ÎÈÎÎñµÃµ½ÁË»Æ½ð×°±¸Ò»¼þ£¬»Æ½ð×°±¸±àºÅÎª£º"..nGoldenID)
	logplayer("dulieu/datau8000.txt",format("[IP : %s ] - Thêi gian : %s  - Tµi kho¶n [ %s] - Nh©n vËt : [%s ] hoan thanh 8000 da tau nhan duoc [%s] ! ",GetIP(),GetLocalDate("%m/%d/%Y_%H:%M:%S"),GetAccount(),GetName(),nGoldenID))
	AddGlobalCountNews("§¹i hiÖp "..GetName().." ®· hoµn thµnh 8000 chuçi nhiÖm vô d· tÈu liªn tiÕp may m¾n nhËn ®­îc trang bÞ HK ", 3);
	for i=1,3 do
		Msg2Player("§· hoµn thµnh 8000 nhiÖm vô d· tÈu liªn tiÕp may m¾n nhËn ®­­îc trang bÞ HK ");
	end
	return
end

if (nTotalTask == 5000) then
	nGoldenID = nAnBang[random(getn(nAnBang))]
	AddGoldItem( 0, nGoldenID )
	--WriteLog("[ÈÎÎñÁ´½±Àø¼ÇÂ¼]"..date("[%yÄê%mÔÂ%dÈÕ%HÊ±%M·Ö]").."£ºÕËºÅ"..GetAccount().."£¬½ÇÉ«"..GetName().."ÔÚÈÎÎñÁ´½±ÀøÖÐÒòÎªÍê³É 8000 ´ÎÈÎÎñµÃµ½ÁË»Æ½ð×°±¸Ò»¼þ£¬»Æ½ð×°±¸±àºÅÎª£º"..nGoldenID)
	logplayer("dulieu/datau4000.txt",format("[IP : %s ] - Thêi gian : %s  - Tµi kho¶n [ %s] - Nh©n vËt : [%s ] hoan thanh 4000 da tau nhan duoc [%s] ! ",GetIP(),GetLocalDate("%m/%d/%Y_%H:%M:%S"),GetAccount(),GetName(),nGoldenID))
	AddGlobalCountNews("§¹i hiÖp "..GetName().." ®· hoµn thµnh 5000 chuçi nhiÖm vô d· tÈu liªn tiÕp may m¾n nhËn ®­îc trang bÞ an bang", 3);
	for i=1,3 do
		Msg2Player("§· hoµn thµnh 5000 nhiÖm vô d· tÈu liªn tiÕp may m¾n nhËn ®­­îc trang bÞ an bang");
	end
	return
end


if (nTotalTask == 3500) then
	nGoldenID = nNhuTinh[random(getn(nNhuTinh))]
	AddGoldItem( 0, nGoldenID )
	--WriteLog("[ÈÎÎñÁ´½±Àø¼ÇÂ¼]"..date("[%yÄê%mÔÂ%dÈÕ%HÊ±%M·Ö]").."£ºÕËºÅ"..GetAccount().."£¬½ÇÉ«"..GetName().."ÔÚÈÎÎñÁ´½±ÀøÖÐÒòÎªÍê³É 8000 ´ÎÈÎÎñµÃµ½ÁË»Æ½ð×°±¸Ò»¼þ£¬»Æ½ð×°±¸±àºÅÎª£º"..nGoldenID)
	logplayer("dulieu/datau2000.txt",format("Thêi gian : %s  - Tµi kho¶n [ %s] - Nh©n vËt : [%s ] hoan thanh 3500 da tau nhan duoc [%s] ! ",GetLocalDate("%m/%d/%Y_%H:%M:%S"),GetAccount(),GetName(),nGoldenID))
	AddGlobalCountNews("§¹i hiÖp "..GetName().." ®· hoµn thµnh 3500 chuçi nhiÖm vô d· tÈu liªn tiÕp may m¾n nhËn ®­îc trang bÞ nhu t×nh", 3);
	for i=1,3 do
		Msg2Player("§· hoµn thµnh 3000 nhiÖm vô d· tÈu liªn tiÕp may m¾n nhËn ®­­îc trang bÞ nhu t×nh");
	end
	return
end

if (nTotalTask == 3000) then
	nGoldenID = nDinhQuoc[random(getn(nDinhQuoc))]
	AddGoldItem( 0, nGoldenID )
	--WriteLog("[ÈÎÎñÁ´½±Àø¼ÇÂ¼]"..date("[%yÄê%mÔÂ%dÈÕ%HÊ±%M·Ö]").."£ºÕËºÅ"..GetAccount().."£¬½ÇÉ«"..GetName().."ÔÚÈÎÎñÁ´½±ÀøÖÐÒòÎªÍê³É 8000 ´ÎÈÎÎñµÃµ½ÁË»Æ½ð×°±¸Ò»¼þ£¬»Æ½ð×°±¸±àºÅÎª£º"..nGoldenID)
	logplayer("dulieu/datau2000.txt",format("Thêi gian : %s  - Tµi kho¶n [ %s] - Nh©n vËt : [%s ] hoan thanh 3000 da tau nhan duoc [%s] ! ",GetLocalDate("%m/%d/%Y_%H:%M:%S"),GetAccount(),GetName(),nGoldenID))
	AddGlobalCountNews("§¹i hiÖp "..GetName().." ®· hoµn thµnh 3000 chuçi nhiÖm vô d· tÈu liªn tiÕp may m¾n nhËn ®­îc trang bÞ ®Þnh quèc", 3);
	for i=1,3 do
		Msg2Player("§· hoµn thµnh 3000 nhiÖm vô d· tÈu liªn tiÕp may m¾n nhËn ®­­îc trang bÞ §Þnh Quèc");
	end
	return
end

if (nTotalTask == 2500) then
	nGoldenID = nHiepCot[random(getn(nHiepCot))]
	AddGoldItem( 0, nGoldenID )
	--WriteLog("[ÈÎÎñÁ´½±Àø¼ÇÂ¼]"..date("[%yÄê%mÔÂ%dÈÕ%HÊ±%M·Ö]").."£ºÕËºÅ"..GetAccount().."£¬½ÇÉ«"..GetName().."ÔÚÈÎÎñÁ´½±ÀøÖÐÒòÎªÍê³É 8000 ´ÎÈÎÎñµÃµ½ÁË»Æ½ð×°±¸Ò»¼þ£¬»Æ½ð×°±¸±àºÅÎª£º"..nGoldenID)
	logplayer("dulieu/datau2000.txt",format("Thêi gian : %s  - Tµi kho¶n [ %s] - Nh©n vËt : [%s ] hoan thanh 2500 da tau nhan duoc [%s] ! ",GetLocalDate("%m/%d/%Y_%H:%M:%S"),GetAccount(),GetName(),nGoldenID))
	AddGlobalCountNews("§¹i hiÖp "..GetName().." ®· hoµn thµnh 2500 chuçi nhiÖm vô d· tÈu liªn tiÕp may m¾n nhËn ®­îc trang bÞ hiÖp cèt", 3);
	for i=1,3 do
		Msg2Player("§· hoµn thµnh 2500 nhiÖm vô d· tÈu liªn tiÕp may m¾n nhËn ®­­îc trang bÞ hiÖp cèt");
	end
	return
end

if (nTotalTask == 200) then
tbAwardTemplet:GiveAwardByList({{szName = "Tiªn Th¶o Lé 1h ", tbProp ={ 6, 1, 71, 1, 1, 0, 0, 0}, nRate = 100, nCount=1}}, format("Get %s", "Tiªn Th¶o Lé"))
	for i=1,3 do
		Msg2Player("§· hoµn thµnh 200 nhiÖm vô d· tÈu liªn tiÕp may m¾n nhËn ®­­îc Tiªn Th¶o Lé");
	end
	return
end

if (nTotalTask == 400) then
tbAwardTemplet:GiveAwardByList({{szName = "QuÕ Hoa Töu", tbProp ={ 6, 1, 125, 1, 1, 0, 0, 0}, nRate = 100, nCount=1}}, format("Get %s", "QuÕ Hoa Töu"))
	for i=1,3 do
		Msg2Player("§· hoµn thµnh 400 nhiÖm vô d· tÈu liªn tiÕp may m¾n nhËn ®­­îc QuÕ Hoa Töu");
	end
	return
end

if (nTotalTask == 600) then
tbAwardTemplet:GiveAwardByList({{szName = "Thñy Tinh", tbProp ={ 4, 239, 1, 1, 1, 0, 0, 0}, nRate = 100, nCount=1}}, format("Get %s", "Thñy Tinh"))
	for i=1,3 do
		Msg2Player("§· hoµn thµnh 600 nhiÖm vô d· tÈu liªn tiÕp may m¾n nhËn ®­­îc Thñy Tinh");
	end
	return
end

if (nTotalTask == 800) then
tbAwardTemplet:GiveAwardByList({{szName = "Tinh Hång B¶o Th¹ch", tbProp ={ 4, 353, 1, 1, 1, 0, 0, 0}, nRate = 100, nCount=1}}, format("Get %s", "Tinh Hång B¶o Th¹ch"))
	for i=1,3 do
		Msg2Player("§· hoµn thµnh 800 nhiÖm vô d· tÈu liªn tiÕp may m¾n nhËn ®­­îc Tinh Hång B¶o Th¹ch");
	end
	return
end

if (nTotalTask == 1000) then
tbAwardTemplet:GiveAwardByList({{szName = "Tiªn Th¶o Lé §Æc BiÖt", tbProp ={ 6, 1, 1181, 1, 1, 0, 0, 0}, nRate = 100, nCount=1}}, format("Get %s", "Tiªn Th¶o Lé §Æc BiÖt"))
	for i=1,3 do
		Msg2Player("§· hoµn thµnh 1000 nhiÖm vô d· tÈu liªn tiÕp may m¾n nhËn ®­­îc Tiªn Th¶o Lé §Æc BiÖt");
	end
	return
end

if (nTotalTask == 1500) then
tbAwardTemplet:GiveAwardByList({{szName = "Vâ L©m MËt TÞch", tbProp ={ 6, 1, 26, 1, 1, 0, 0, 0}, nRate = 100, nCount=1}}, format("Get %s", "Vâ L©m MËt TÞch"))
	for i=1,3 do
		Msg2Player("§· hoµn thµnh 1500 nhiÖm vô d· tÈu liªn tiÕp may m¾n nhËn ®­­îc Vâ L©m MËt TÞch");
	end
	return
end

if (nTotalTask == 2000) then
tbAwardTemplet:GiveAwardByList({{szName = "TÈy Tñy Kinh", tbProp ={ 6, 1, 22, 1, 1, 0, 0, 0}, nRate = 100, nCount=1}}, format("Get %s", "TÈy Tñy Kinh"))
	for i=1,3 do
		Msg2Player("§· hoµn thµnh 2000 nhiÖm vô d· tÈu liªn tiÕp may m¾n nhËn ®­­îc TÈy Tñy Kinh");
	end
	return
end
---------------------------------------------------------------
storm_ask2start(4, 1)	--Storm ¿ªÊ¼ÌôÕ½

end

function logplayer(zFile,szMsg)
  local handle = openfile(zFile,"a")
  write(handle,format("%s\n",szMsg));
  closefile(handle);
 end

function _TaskLinkDebug()

	if (nt_getTask(1030)==0) and (tl_gettaskcourse()==1) then
		nt_setTask(1030,2);
		tl_savetalkvalue(1,2);
		tl_savetalkvalue(2,2);
		tl_savetalkvalue(3,2);
		tl_savetalkvalue(4,2);
		tl_savetalkvalue(5,2);
		tl_savetalkvalue(6,2);
	end

end

function _CancelTaskDebug()

local nOrgTask = GetTask(DEBUG_TASKVALUE);
local nDecTask = tl_gettaskstate(4);
local nDiff    = 0;

	if nOrgTask==nDecTask or nOrgTask==0 then
		return 1;
	else
		WriteLog(" [B¶ng nhiÖm vô ®· ghi nhí sai]"..
				 date(" [%yn¨m%mth¸ng%dngµy%Hgiê%Mphót%Sgi©y]")..
				 " [Tµi kho¶n]"..GetAccount()..
				 " [Nh©n vËt]"..GetName()..
				 "C¬ héi hñy bá kh«ng c©n b»ng, hiÖn t¹i c¬ héi hñy bá cßn <"..nDecTask.."> lÇn, phÇn c¬ héi hñy bá cßn <"..nOrgTask..">.");
		return 0;
	end;

end;


function _WriteCancelLog(nType, nTime, nCancel)

	if nType==1 then
		WriteLog(" [Hñy bá kû lôc nhiÖm vô liªn tiÕp]"..date(" [%y n¨m %m th¸ng %d ngµy  %H giê %M phót]")..": Tµi kho¶n"..GetAccount()..", nh©n vËt"..GetName().."T¹i nhiÖm vô thø "..nTime.."Hñy bá c¬ héi cßn d­ "..nCancel.."giê hñy bá mét lÇn nhiÖm vô.");
	else
		WriteLog(" [Hñy bá kû lôc nhiÖm vô liªn tiÕp]"..date(" [%y n¨m %m th¸ng %d ngµy  %H giê %M phót]")..": Tµi kho¶n"..GetAccount()..", nh©n vËt"..GetName().."T¹i nhiÖm vô thø "..nTime.." dïng 100 tÊm s¬n Hµ X· T¾c hñy bá nhiÖm vô.");
	end;

end;

